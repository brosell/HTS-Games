<HTML>
<HEAD>
<TITLE>
StdString.h
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="green">// =============================================================================</font>
<font color="green">//  FILE:  StdString.h</font>
<font color="green">//  AUTHOR: Joe O'Leary (with outside help noted in comments)</font>
<font color="green">//  REMARKS:</font>
<font color="green">//      This header file declares the CStdStr template.  This template derives</font>
<font color="green">//      the Standard C++ Library basic_string&#60;&#62; template and add to it the</font>
<font color="green">//      the following conveniences:</font>
<font color="green">//          - The full MFC CString set of functions (including implicit cast)</font>
<font color="green">//          - writing to/reading from COM IStream interfaces</font>
<font color="green">//          - Functional objects for use in STL algorithms</font>
<font color="green">//</font>
<font color="green">//      From this template, we intstantiate two classes:  CStdStringA and</font>
<font color="green">//      CStdStringW.  The name "CStdString" is just a #define of one of these,</font>
<font color="green">//      based upone the _UNICODE macro setting</font>
<font color="green">//</font>
<font color="green">//      This header also declares our own version of the MFC/ATL UNICODE-MBCS</font>
<font color="green">//      conversion macros.  Our version looks exactly like the Microsoft's to</font>
<font color="green">//      facilitate portability.</font>
<font color="green">//</font>
<font color="green">//  NOTE:</font>
<font color="green">//      If you you use this in an MFC or ATL build, you should include either</font>
<font color="green">//      afx.h or atlbase.h first, as appropriate.</font>
<font color="green">//</font>
<font color="green">//  PEOPLE WHO HAVE CONTRIBUTED TO THIS CLASS:</font>
<font color="green">//</font>
<font color="green">//      Several people have helped me iron out problems and othewise improve</font>
<font color="green">//      this class.  OK, this is a long list but in my own defense, this code</font>
<font color="green">//      has undergone two major rewrites.  Many of the improvements became</font>
<font color="green">//      necessary after I rewrote the code as a template.  Others helped me</font>
<font color="green">//      improve the CString facade.</font>
<font color="green">//</font>
<font color="green">//      Anyway, these people are (in chronological order):</font>
<font color="green">//</font>
<font color="green">//          - Pete the Plumber (???)</font>
<font color="green">//          - Julian Selman</font>
<font color="green">//          - Chris (of Melbsys)</font>
<font color="green">//          - Dave Plummer</font>
<font color="green">//          - John C Sipos</font>
<font color="green">//          - Chris Sells</font>
<font color="green">//          - Nigel Nunn</font>
<font color="green">//          - Fan Xia</font>
<font color="green">//          - Matthew Williams</font>
<font color="green">//          - Carl Engman</font>
<font color="green">//          - Mark Zeren</font>
<font color="green">//          - Craig Watson</font>
<font color="green">//          - Rich Zuris</font>
<font color="green">//          - Karim Ratib</font>
<font color="green">//          - Chris Conti</font>
<font color="green">//          - Baptiste Lepilleur</font>
<font color="green">//          - Greg Pickles</font>
<font color="green">//          - Jim Cline</font>
<font color="green">//          - Jeff Kohn</font>
<font color="green">//          - Todd Heckel</font>
<font color="green">//          - Ullrich Pollähne</font>
<font color="green">//</font>
<font color="green">//  REVISION HISTORY</font>
<font color="green">//</font>
<font color="green">//    2000-MAR-07 - Thanks to Ullrich Pollähne for catching a range bug in one</font>
<font color="green">//                  of the overloads of assign.</font>
<font color="green">//</font>
<font color="green">//    2000-FEB-01 - You can now use CStdString on the Mac with CodeWarrior!</font>
<font color="green">//                  Thanks to Todd Heckel for helping out with this.</font>
<font color="green">//</font>
<font color="green">//    2000-JAN-23 - Thanks to Jim Cline for pointing out how I could make the</font>
<font color="green">//                  Trim() function more efficient.</font>
<font color="green">//                - Thanks to Jeff Kohn for prompting me to find and fix a typo</font>
<font color="green">//                  in one of the addition operators that takes _bstr_t.</font>
<font color="green">//                - Got rid of the .CPP file -  you only need StdString.h now!</font>
<font color="green">//</font>
<font color="green">//    1999-DEC-22 - Thanks to Greg Pickles for helping me identify a problem</font>
<font color="green">//                  with my implementation of CStdString::FormatV in which</font>
<font color="green">//                  resulting string might not be properly NULL terminated.</font>
<font color="green">//</font>
<font color="green">//    1999-DEC-06 - Chris Conti pointed yet another basic_string&#60;&#62; assignment</font>
<font color="green">//                  bug that MS has not fixed.  CStdString did nothing to fix</font>
<font color="green">//                  it either but it does now!  The bug was: create a string</font>
<font color="green">//                  longer than 31 characters, get a pointer to it (via c_str())</font>
<font color="green">//                  and then assign that pointer to the original string object.</font>
<font color="green">//                  The resulting string would be empty.  Not with CStdString!</font>
<font color="green">//</font>
<font color="green">//    1999-OCT-06 - BufferSet was erasing the string even when it was merely</font>
<font color="green">//                  supposed to shrink it.  Fixed.  Thanks to Chris Conti.</font>
<font color="green">//                - Some of the Q172398 fixes were not checking for assignment-</font>
<font color="green">//                  to-self.  Fixed.  Thanks to Baptiste Lepilleur.</font>
<font color="green">//</font>
<font color="green">//    1999-AUG-20 - Improved Load() function to be more efficient by using </font>
<font color="green">//                  SizeOfResource().  Thanks to Rich Zuris for this.</font>
<font color="green">//                - Corrected resource ID constructor, again thanks to Rich.</font>
<font color="green">//                - Fixed a bug that occurred with UNICODE characters above</font>
<font color="green">//                  the first 255 ANSI ones.  Thanks to Craig Watson. </font>
<font color="green">//                - Added missing overloads of TrimLeft() and TrimRight().</font>
<font color="green">//                  Thanks to Karim Ratib for pointing them out</font>
<font color="green">//</font>
<font color="green">//    1999-JUL-21 - Made all calls to Buffer() with no args check length first.</font>
<font color="green">//</font>
<font color="green">//    1999-JUL-10 - Improved MFC/ATL independence of conversion macros</font>
<font color="green">//                - Added SS_NO_REFCOUNT macro to allow you to disable any</font>
<font color="green">//                  reference-counting your basic_string&#60;&#62; impl. may do.</font>
<font color="green">//                - Improved ReleaseBuffer() to be as forgiving as CString.</font>
<font color="green">//                  Thanks for Fan Xia for helping me find this and to</font>
<font color="green">//                  Matthew Williams for pointing it out directly.</font>
<font color="green">//</font>
<font color="green">//    1999-JUL-06 - Thanks to Nigel Nunn for catching a very sneaky bug in</font>
<font color="green">//                  ToLower/ToUpper.  They should call Buffer() instead of</font>
<font color="green">//                  data() in order to ensure the changed string buffer is not</font>
<font color="green">//                  reference-counted (in those implementations that refcount).</font>
<font color="green">//</font>
<font color="green">//    1999-JUL-01 - Added a true CString facade.  Now you can use CStdString as</font>
<font color="green">//                  a drop-in replacement for CString.  If you find this useful,</font>
<font color="green">//                  you can thank Chris Sells for finally convincing me to give</font>
<font color="green">//                  in and implement it.</font>
<font color="green">//                - Changed operators &#60;&#60; and &#62;&#62; (for MFC CArchive) to serialize</font>
<font color="green">//                  EXACTLY as CString's do.  So now you can send a CString out</font>
<font color="green">//                  to a CArchive and later read it in as a CStdString.   I have</font>
<font color="green">//                  no idea why you would want to do this but you can. </font>
<font color="green">//</font>
<font color="green">//    1999-JUN-21 - Changed the CStdString class into the CStdStr template.</font>
<font color="green">//                - Fixed FormatV() to correctly decrement the loop counter.</font>
<font color="green">//                  This was harmless bug but a bug nevertheless.  Thanks to</font>
<font color="green">//                  Chris (of Melbsys) for pointing it out</font>
<font color="green">//                - Changed Format() to try a normal stack-based array before</font>
<font color="green">//                  using to _alloca().</font>
<font color="green">//                - Updated the text conversion macros to properly use code</font>
<font color="green">//                  pages and to fit in better in MFC/ATL builds.  In other</font>
<font color="green">//                  words, I copied Microsoft's conversion stuff again. </font>
<font color="green">//                - Added equivalents of CString::GetBuffer, GetBufferSetLength</font>
<font color="green">//                - new sscpy() replacement of CStdString::CopyString()</font>
<font color="green">//                - a Trim() function that combines TrimRight() and TrimLeft().</font>
<font color="green">//</font>
<font color="green">//    1999-MAR-13 - Corrected the "NotSpace" functional object to use _istpace()</font>
<font color="green">//                  instead of _isspace()   Thanks to Dave Plummer for this.</font>
<font color="green">//</font>
<font color="green">//    1999-FEB-26 - Removed errant line (left over from testing) that #defined</font>
<font color="green">//                  _MFC_VER.  Thanks to John C Sipos for noticing this.</font>
<font color="green">//</font>
<font color="green">//    1999-FEB-03 - Fixed a bug in a rarely-used overload of operator+() that</font>
<font color="green">//                  caused infinite recursion and stack overflow</font>
<font color="green">//                - Added member functions to simplify the process of</font>
<font color="green">//                  persisting CStdStrings to/from DCOM IStream interfaces </font>
<font color="green">//                - Added functional objects (e.g. StdStringLessNoCase) that</font>
<font color="green">//                  allow CStdStrings to be used as keys STL map objects with</font>
<font color="green">//                  case-insensitive comparison </font>
<font color="green">//                - Added array indexing operators (i.e. operator[]).  I</font>
<font color="green">//                  originally assumed that these were unnecessary and would be</font>
<font color="green">//                  inherited from basic_string.  However, without them, Visual</font>
<font color="green">//                  C++ complains about ambiguous overloads when you try to use</font>
<font color="green">//                  them.  Thanks to Julian Selman to pointing this out. </font>
<font color="green">//</font>
<font color="green">//    1998-FEB-?? - Added overloads of assign() function to completely account</font>
<font color="green">//                  for Q172398 bug.  Thanks to "Pete the Plumber" for this</font>
<font color="green">//</font>
<font color="green">//    1998-FEB-?? - Initial submission</font>
<font color="green">//</font>
<font color="green">// COPYRIGHT:</font>
<font color="green">//      1999 Joseph M. O'Leary.  This code is free.  Use it anywhere you want.</font>
<font color="green">//      Rewrite it, restructure it, whatever.  Please don't blame me if it makes</font>
<font color="green">//      your $30 billion dollar satellite explode in orbit.  If you redistribute</font>
<font color="green">//      it in any form, I'd appreciate it if you would leave this notice here.</font>
<font color="green">//</font>
<font color="green">//      If you find any bugs, please let me know:</font>
<font color="green">//</font>
<font color="green">//              jmoleary@earthlink.net</font>
<font color="green">//              http://home.earthlink.net/~jmoleary</font>
<font color="green">// =============================================================================</font>

<font color="green">// Avoid multiple inclusion the VC++ way,</font>
<font color="green">// Turn off browser references</font>
<font color="green">// Turn off unavoidable compiler warnings</font>

<font color="blue">#if</font> defined<font color="black">(</font>_MSC_VER<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font>_MSC_VER <font color="black">&#62;</font> <font color="maroon">1100</font><font color="black">)</font>
    <font color="blue">#pragma</font> once
    <font color="blue">#pragma</font> component<font color="black">(</font>browser, off, references, <font color="maroon">"CStdString"</font><font color="black">)</font>
    <font color="blue">#pragma</font> <font color="blue">warning</font> <font color="black">(</font>disable <font color="black">:</font> <font color="maroon">4290</font><font color="black">)</font> <font color="green">// C++ Exception Specification ignored</font>
    <font color="blue">#pragma</font> <font color="blue">warning</font> <font color="black">(</font>disable <font color="black">:</font> <font color="maroon">4127</font><font color="black">)</font> <font color="green">// Conditional expression is constant</font>
    <font color="blue">#pragma</font> <font color="blue">warning</font> <font color="black">(</font>disable <font color="black">:</font> <font color="maroon">4097</font><font color="black">)</font> <font color="green">// typedef name used as synonym for class name</font>
<font color="blue">#endif</font>

<font color="blue">#ifndef</font> _STDSTRING_H_
<font color="blue">#define</font> _STDSTRING_H_


<font color="green">// MACRO: SS_NO_REFCOUNT:</font>
<font color="green">//      turns off reference counting at the assignment level</font>
<font color="green">//      I define this by default.  comment it out if you don't want it.</font>

<font color="blue">#define</font> SS_NO_REFCOUNT  

<font color="green">// In non-Visual C++ and/or non-Win32 builds, we can't use some cool stuff.</font>

<font color="blue">#if</font> <font color="black">!</font>defined<font color="black">(</font>_MSC_VER<font color="black">)</font> <font color="black">|</font><font color="black">|</font> <font color="black">!</font>defined<font color="black">(</font>_WIN32<font color="black">)</font>
    <font color="blue">#define</font> SS_ANSI
<font color="blue">#endif</font>

<font color="green">// Avoid legacy code screw up: if _UNICODE is defined, UNICODE must be as well</font>

<font color="blue">#if</font> defined <font color="black">(</font>_UNICODE<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font>defined <font color="black">(</font>UNICODE<font color="black">)</font>
    <font color="blue">#define</font> UNICODE
<font color="blue">#endif</font>
<font color="blue">#if</font> defined <font color="black">(</font>UNICODE<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font>defined <font color="black">(</font>_UNICODE<font color="black">)</font>
    <font color="blue">#define</font> _UNICODE
<font color="blue">#endif</font>

<font color="green">// If this class is not being built as a part of the W32 library, then we have</font>
<font color="green">// not yet included W32Base.h so we've got to include and define all the</font>
<font color="green">// necessary stuff here.</font>

<font color="blue">#if</font> <font color="black">!</font>defined<font color="black">(</font>_W32BASE_H_<font color="black">)</font>

    <font color="blue">template</font><font color="black">&#60;</font><font color="blue">class</font> Type<font color="black">&#62;</font>
    <font color="blue">inline</font> <font color="blue">const</font> Type<font color="black">&</font> SSMIN<font color="black">(</font><font color="blue">const</font> Type<font color="black">&</font> arg1, <font color="blue">const</font> Type<font color="black">&</font> arg2<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> arg2 <font color="black">&#60;</font> arg1 ? arg2 <font color="black">:</font> arg1;
    <font color="black">}</font>

    <font color="green">// If they want us to use only standard C++ stuff (no Win32 stuff)</font>

    <font color="blue">#ifdef</font> SS_ANSI

        <font color="green">// On non-Win32 platforms, there is no TCHAR.H so define what we need</font>

        <font color="blue">#ifndef</font> _WIN32


            <font color="blue">typedef</font> <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font>     PCSTR;
            <font color="blue">typedef</font> <font color="blue">char</font><font color="black">*</font>           PSTR;
            <font color="blue">typedef</font> <font color="blue">const</font> wchar_t<font color="black">*</font>  PCWSTR;
            <font color="blue">typedef</font> wchar_t<font color="black">*</font>        PWSTR;
            <font color="blue">#ifdef</font> UNICODE
                <font color="blue">typedef</font> wchar_t     TCHAR;
            <font color="blue">#else</font>
                <font color="blue">typedef</font> <font color="blue">char</font>        TCHAR;
            <font color="blue">#endif</font>
            <font color="blue">typedef</font> wchar_t         OLECHAR;

        <font color="blue">#else</font>

            <font color="blue">#include</font> <font color="maroon">&#60;TCHAR.H&#62;</font>
            <font color="blue">#include</font> <font color="maroon">&#60;WTYPES.H&#62;</font>
            <font color="blue">#ifndef</font> STRICT
                <font color="blue">#define</font> STRICT
            <font color="blue">#endif</font>

        <font color="blue">#endif</font>  <font color="green">// #ifndef _WIN32</font>


        <font color="green">// Make sure ASSERT and verify are defined in an ANSI fashion</font>

        <font color="blue">#ifndef</font> ASSERT
            <font color="blue">#include</font> <font color="maroon">&#60;assert.h&#62;</font>
            <font color="blue">#define</font> ASSERT<font color="black">(</font>f<font color="black">)</font> assert<font color="black">(</font><font color="black">(</font>f<font color="black">)</font><font color="black">)</font>
        <font color="blue">#endif</font>
        <font color="blue">#ifndef</font> VERIFY
            <font color="blue">#ifdef</font> _DEBUG
                <font color="blue">#define</font> VERIFY<font color="black">(</font>x<font color="black">)</font> ASSERT<font color="black">(</font><font color="black">(</font>x<font color="black">)</font><font color="black">)</font>
            <font color="blue">#else</font>
                <font color="blue">#define</font> VERIFY<font color="black">(</font>x<font color="black">)</font> x
            <font color="blue">#endif</font>
        <font color="blue">#endif</font>

    <font color="blue">#else</font> <font color="green">// #ifdef SS_ANSI</font>

        <font color="blue">#include</font> <font color="maroon">&#60;TCHAR.H&#62;</font>
        <font color="blue">#include</font> <font color="maroon">&#60;WTYPES.H&#62;</font>
        <font color="blue">#ifndef</font> STRICT
            <font color="blue">#define</font> STRICT
        <font color="blue">#endif</font>

<font color="green">//      #include &#60;windows.h&#62;</font>

        <font color="green">// Make sure ASSERT and verify are defined</font>

        <font color="blue">#ifndef</font> ASSERT
            <font color="blue">#include</font> <font color="maroon">&#60;crtdbg.h&#62;</font>
            <font color="blue">#define</font> ASSERT<font color="black">(</font>f<font color="black">)</font> _ASSERTE<font color="black">(</font><font color="black">(</font>f<font color="black">)</font><font color="black">)</font>
        <font color="blue">#endif</font>
        <font color="blue">#ifndef</font> VERIFY
            <font color="blue">#ifdef</font> _DEBUG
                <font color="blue">#define</font> VERIFY<font color="black">(</font>x<font color="black">)</font> ASSERT<font color="black">(</font><font color="black">(</font>x<font color="black">)</font><font color="black">)</font>
            <font color="blue">#else</font>
                <font color="blue">#define</font> VERIFY<font color="black">(</font>x<font color="black">)</font> x
            <font color="blue">#endif</font>
        <font color="blue">#endif</font>

    <font color="blue">#endif</font> <font color="green">// #ifdef SS_ANSI</font>

<font color="blue">#else</font> 

    <font color="blue">#define</font> NSP std
    <font color="blue">#define</font> SSMIN W32MIN

<font color="blue">#endif</font> <font color="green">// #ifndef _W32BASE_H_</font>

<font color="green">// Standard headers needed</font>

<font color="blue">#include</font> <font color="maroon">&#60;string&#62;</font>           <font color="green">// basic_string</font>
<font color="blue">#include</font> <font color="maroon">&#60;algorithm&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;functional&#62;</font>       <font color="green">// for StdStringLessNoCase, et al</font>
<font color="blue">#include</font> <font color="maroon">&#60;locale&#62;</font>           <font color="green">// for various facets</font>

<font color="green">// MACRO: NSP</font>
<font color="green">// Defines the name of the namespace the standard library resides in.</font>
<font color="green">// Some implementations place the standard library in other namespaces or in</font>
<font color="green">// no namespace at all.  You can just change this definition to use whatever</font>
<font color="green">// you want</font>
<font color="green">// Note:  This technique results in global scope being explicitly used if you</font>
<font color="green">// #define NSP nothing.  (e.g. '::wstring' instead of just 'wstring').  I</font>
<font color="green">// Suppose this could interfere with Koenig Lookup, but I'm taking that chance.</font>

<font color="blue">#ifndef</font> NSP
    <font color="blue">#define</font> NSP             std
<font color="blue">#endif</font>

<font color="green">// If this is a recent enough version of VC include comdef.h, so we can write</font>
<font color="green">// member functions to deal with COM types & compiler support classes e.g. _bstr_t</font>

<font color="blue">#if</font> defined <font color="black">(</font>_MSC_VER<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font>_MSC_VER <font color="black">&#62;</font><font color="black">=</font> <font color="maroon">1100</font><font color="black">)</font>
    <font color="blue">#include</font> <font color="maroon">&#60;comdef.h&#62;</font>
    <font color="blue">#define</font> SS_INC_COMDEF       <font color="green">// signal that we #included MS comdef.h file</font>
    <font color="blue">#define</font> STDSTRING_INC_COMDEF
<font color="blue">#endif</font>

<font color="blue">#ifndef</font> TRACE
    <font color="blue">#define</font> TRACE_DEFINED_HERE
    <font color="blue">#define</font> TRACE
<font color="blue">#endif</font>

<font color="green">// Microsoft defines PCSTR, PCWSTR, etc, but no PCTSTR.  I hate to use the</font>
<font color="green">// versions with the "L" in front of them because that's a leftover from Win 16</font>
<font color="green">// days, even though it evaluates to the same thing.  Therefore, Define a PCSTR</font>
<font color="green">// as an LPCTSTR.</font>

<font color="blue">#if</font> <font color="black">!</font>defined<font color="black">(</font>PCTSTR<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font>defined<font color="black">(</font>PCTSTR_DEFINED<font color="black">)</font>
    <font color="blue">typedef</font> <font color="blue">const</font> TCHAR<font color="black">*</font>            PCTSTR;
    <font color="blue">#define</font> PCTSTR_DEFINED
<font color="blue">#endif</font>

<font color="blue">#if</font> <font color="black">!</font>defined<font color="black">(</font>PCOLESTR<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font>defined<font color="black">(</font>PCOLESTR_DEFINED<font color="black">)</font>
    <font color="blue">typedef</font> <font color="blue">const</font> OLECHAR<font color="black">*</font>          PCOLESTR;
    <font color="blue">#define</font> PCOLESTR_DEFINED
<font color="blue">#endif</font>

<font color="blue">#if</font> <font color="black">!</font>defined<font color="black">(</font>POLESTR<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font>defined<font color="black">(</font>POLESTR_DEFINED<font color="black">)</font>
    <font color="blue">typedef</font> OLECHAR<font color="black">*</font>                POLESTR;
    <font color="blue">#define</font> POLESTR_DEFINED
<font color="blue">#endif</font>

<font color="blue">#if</font> <font color="black">!</font>defined<font color="black">(</font>PCUSTR<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font>defined<font color="black">(</font>PCUSTR_DEFINED<font color="black">)</font>
    <font color="blue">typedef</font> <font color="blue">const</font> <font color="blue">unsigned</font> <font color="blue">char</font><font color="black">*</font>    PCUSTR;
    <font color="blue">typedef</font> <font color="blue">unsigned</font> <font color="blue">char</font><font color="black">*</font>          PUSTR;
    <font color="blue">#define</font> PCUSTR_DEFINED
<font color="blue">#endif</font>

<font color="green">// SS_USE_FACET macro and why we need it:</font>
<font color="green">//</font>
<font color="green">// Since I'm a good little Standard C++ programmer, I use locales.  Thus, I</font>
<font color="green">// need to make use of the use_facet&#60;&#62; template function here.   Unfortunately,</font>
<font color="green">// this need is complicated by the fact the MS' implementation of the Standard</font>
<font color="green">// C++ Library has a non-standard version of use_facet that takes more</font>
<font color="green">// arguments than the standard dictates.  Since I'm trying to write CStdString</font>
<font color="green">// to work with any version of the Standard library, this presents a problem.</font>
<font color="green">//</font>
<font color="green">// The upshot of this is that I can't do 'use_facet' directly.  The MS' docs</font>
<font color="green">// tell me that I have to use a macro, _USE() instead.  Since _USE obviously</font>
<font color="green">// won't be available in other implementations, this means that I have to write</font>
<font color="green">// my OWN macro -- SS_USE_FACET -- that evaluates either to _USE or to the</font>
<font color="green">// standard, use_facet.</font>
<font color="green">//</font>
<font color="green">// If you are having trouble with the SS_USE_FACET macro, in your implementation</font>
<font color="green">// of the Standard C++ Library, you can define your own version of SS_USE_FACET.</font>

<font color="blue">#ifndef</font> SS_USE_FACET
    <font color="blue">#ifdef</font> _MSC_VER 
        <font color="blue">#define</font> SS_USE_FACET<font color="black">(</font>loc, fac<font color="black">)</font> NSP<font color="black">:</font><font color="black">:</font>_USE<font color="black">(</font>loc,fac<font color="black">)</font>
    <font color="blue">#else</font>
        <font color="blue">#define</font> SS_USE_FACET<font color="black">(</font>loc, fac<font color="black">)</font> NSP<font color="black">:</font><font color="black">:</font>use_facet<font color="black">&#60;</font>fac<font color="black">&#62;</font><font color="black">(</font>loc<font color="black">)</font>
    <font color="blue">#endif</font>
<font color="blue">#endif</font>

<font color="green">// =============================================================================</font>
<font color="green">// UNICODE/MBCS conversion macros.  Made to work just like the MFC/ATL ones.</font>
<font color="green">// =============================================================================</font>

<font color="green">// First define the conversion helper functions.  We define these regardless of</font>
<font color="green">// any preprocessor macro settings since their names won't collide. </font>

<font color="blue">#ifdef</font> SS_ANSI <font color="green">// Are we doing things the standard, non-Win32 way?...</font>

    <font color="blue">typedef</font> NSP<font color="black">:</font><font color="black">:</font>codecvt<font color="black">&#60;</font>wchar_t, <font color="blue">char</font>, mbstate_t<font color="black">&#62;</font> SSCodeCvt;

    <font color="green">// Not sure if we need all these headers.   I believe ANSI says we do.</font>

    <font color="blue">#include</font> <font color="maroon">&#60;stdio.h&#62;</font>
    <font color="blue">#include</font> <font color="maroon">&#60;stdarg.h&#62;</font>
    <font color="blue">#include</font> <font color="maroon">&#60;wchar.h&#62;</font>
    <font color="blue">#ifndef</font> va_start
        <font color="blue">#include</font> <font color="maroon">&#60;varargs.h&#62;</font>
    <font color="blue">#endif</font>

    <font color="blue">inline</font> PWSTR StdCodeCvt<font color="black">(</font>PWSTR pW, PCSTR pA, <font color="blue">int</font> nChars<font color="black">)</font>
    <font color="black">{</font>
        PSTR pBadA              <font color="black">=</font> NULL;
        PWSTR pBadW             <font color="black">=</font> NULL;
        SSCodeCvt<font color="black">:</font><font color="black">:</font>result res   <font color="black">=</font> SSCodeCvt<font color="black">:</font><font color="black">:</font>ok;
        <font color="blue">const</font> SSCodeCvt<font color="black">&</font> conv   <font color="black">=</font> SS_USE_FACET<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>locale<font color="black">(</font><font color="black">)</font>, SSCodeCvt<font color="black">)</font>;
        res                     <font color="black">=</font> conv.in<font color="black">(</font>res,
                                          pA, pA <font color="black">+</font> nChars, pBadA,
                                          pW, pW <font color="black">+</font> nChars, pBadW<font color="black">)</font>;
        ASSERT<font color="black">(</font>SSCodeCvt<font color="black">:</font><font color="black">:</font>ok <font color="black">=</font><font color="black">=</font> res<font color="black">)</font>;
        <font color="blue">return</font> pW;
    <font color="black">}</font>

    <font color="blue">inline</font> PSTR StdCodeCvt<font color="black">(</font>PSTR pA, PCWSTR pW, <font color="blue">int</font> nChars<font color="black">)</font>
    <font color="black">{</font>
        PSTR pBadA              <font color="black">=</font> NULL;
        PWSTR pBadW             <font color="black">=</font> NULL;
        <font color="blue">const</font> SSCodeCvt<font color="black">&</font> conv   <font color="black">=</font> SS_USE_FACET<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>locale<font color="black">(</font><font color="black">)</font>, SSCodeCvt<font color="black">)</font>;
        SSCodeCvt<font color="black">:</font><font color="black">:</font>result res   <font color="black">=</font> SSCodeCvt<font color="black">:</font><font color="black">:</font>ok;
        res                     <font color="black">=</font> conv.out<font color="black">(</font>res,
                                           pW, pW <font color="black">+</font> nChars, pBadW,
                                           pA, pA <font color="black">+</font> nChars, pBadA<font color="black">)</font>;
        ASSERT<font color="black">(</font>SSCodeCvt<font color="black">:</font><font color="black">:</font>ok <font color="black">=</font><font color="black">=</font> res<font color="black">)</font>;
        <font color="blue">return</font> pA;
    <font color="black">}</font>

<font color="blue">#else</font>   <font color="green">// ...or are we doing things assuming win32 and Visual C++?</font>

    <font color="blue">#include</font> <font color="maroon">&#60;malloc.h&#62;</font> <font color="green">// needed for _alloca</font>

    <font color="blue">inline</font> PWSTR StdCodeCvt<font color="black">(</font>PWSTR pW, PCSTR pA, <font color="blue">int</font> nChars, UINT acp<font color="black">=</font>CP_ACP<font color="black">)</font>
    <font color="black">{</font>
        ASSERT<font color="black">(</font>pA <font color="black">!</font><font color="black">=</font> NULL<font color="black">)</font>;
        ASSERT<font color="black">(</font>pW <font color="black">!</font><font color="black">=</font> NULL<font color="black">)</font>;
        pW<font color="black">[</font><font color="maroon">0</font><font color="black">]</font> <font color="black">=</font> <font color="maroon">'\0'</font>;
        MultiByteToWideChar<font color="black">(</font>acp, <font color="maroon">0</font>, pA, <font color="maroon">-1</font>, pW, nChars<font color="black">)</font>;
        <font color="blue">return</font> pW;
    <font color="black">}</font>

    <font color="blue">inline</font> PSTR StdCodeCvt<font color="black">(</font>PSTR pA, PCWSTR pW, <font color="blue">int</font> nChars, UINT acp<font color="black">=</font>CP_ACP<font color="black">)</font>
    <font color="black">{</font>
        ASSERT<font color="black">(</font>pA <font color="black">!</font><font color="black">=</font> NULL<font color="black">)</font>;
        ASSERT<font color="black">(</font>pW <font color="black">!</font><font color="black">=</font> NULL<font color="black">)</font>;
        pA<font color="black">[</font><font color="maroon">0</font><font color="black">]</font> <font color="black">=</font> <font color="maroon">'\0'</font>;
        WideCharToMultiByte<font color="black">(</font>acp, <font color="maroon">0</font>, pW, <font color="maroon">-1</font>, pA, nChars, NULL, NULL<font color="black">)</font>;
        <font color="blue">return</font> pA;
    <font color="black">}</font>

    <font color="green">// Define our conversion macros to look exactly like Microsoft's to</font>
    <font color="green">// facilitate using this stuff both with and without MFC/ATL</font>

    <font color="blue">#ifdef</font> _CONVERSION_USES_THREAD_LOCALE
        <font color="blue">#ifndef</font> _DEBUG
            <font color="blue">#define</font> SSCVT <font color="blue">int</font> _cvt; _cvt; UINT _acp<font color="black">=</font>GetACP<font color="black">(</font><font color="black">)</font>; \
                _acp; PCWSTR _pw; _pw; PCSTR _pa; _pa
        <font color="blue">#else</font>
            <font color="blue">#define</font> SSCVT <font color="blue">int</font> _cvt <font color="black">=</font> <font color="maroon">0</font>; _cvt; UINT _acp<font color="black">=</font>GetACP<font color="black">(</font><font color="black">)</font>;\
                 _acp; PCWSTR _pw<font color="black">=</font>NULL; _pw; PCSTR _pa<font color="black">=</font>NULL; _pa
        <font color="blue">#endif</font>
    <font color="blue">#else</font>
        <font color="blue">#ifndef</font> _DEBUG
            <font color="blue">#define</font> SSCVT <font color="blue">int</font> _cvt; _cvt; UINT _acp<font color="black">=</font>CP_ACP; _acp;\
                 PCWSTR _pw; _pw; PCSTR _pa; _pa
        <font color="blue">#else</font>
            <font color="blue">#define</font> SSCVT <font color="blue">int</font> _cvt <font color="black">=</font> <font color="maroon">0</font>; _cvt; UINT _acp<font color="black">=</font>CP_ACP; \
                _acp; PCWSTR _pw<font color="black">=</font>NULL; _pw; PCSTR _pa<font color="black">=</font>NULL; _pa
        <font color="blue">#endif</font>
    <font color="blue">#endif</font>

    <font color="blue">#ifdef</font> _CONVERSION_USES_THREAD_LOCALE
        <font color="blue">#define</font> SSA2W<font color="black">(</font>pa<font color="black">)</font> <font color="black">(</font>\
            <font color="black">(</font><font color="black">(</font>_pa <font color="black">=</font> pa<font color="black">)</font> <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> ? NULL <font color="black">:</font> <font color="black">(</font>\
                _cvt <font color="black">=</font> <font color="black">(</font>strlen<font color="black">(</font>_pa<font color="black">)</font><font color="black">+</font><font color="maroon">1</font><font color="black">)</font>,\
                StdCodeCvt<font color="black">(</font><font color="black">(</font>PWSTR<font color="black">)</font> _alloca<font color="black">(</font>_cvt<font color="black">*</font><font color="maroon">2</font><font color="black">)</font>, _pa, _cvt, _acp<font color="black">)</font><font color="black">)</font><font color="black">)</font>
        <font color="blue">#define</font> SSW2A<font color="black">(</font>pw<font color="black">)</font> <font color="black">(</font>\
            <font color="black">(</font><font color="black">(</font>_pw <font color="black">=</font> pw<font color="black">)</font> <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> ? NULL <font color="black">:</font> <font color="black">(</font>\
                _cvt <font color="black">=</font> <font color="black">(</font>wcslen<font color="black">(</font>_pw<font color="black">)</font><font color="black">+</font><font color="maroon">1</font><font color="black">)</font><font color="black">*</font><font color="maroon">2</font>,\
                StdW2AHelper<font color="black">(</font><font color="black">(</font>LPSTR<font color="black">)</font> _alloca<font color="black">(</font>_cvt<font color="black">)</font>, _pw, _cvt, _acp<font color="black">)</font><font color="black">)</font><font color="black">)</font>
    <font color="blue">#else</font>
        <font color="blue">#define</font> SSA2W<font color="black">(</font>pa<font color="black">)</font> <font color="black">(</font>\
            <font color="black">(</font><font color="black">(</font>_pa <font color="black">=</font> pa<font color="black">)</font> <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> ? NULL <font color="black">:</font> <font color="black">(</font>\
                _cvt <font color="black">=</font> <font color="black">(</font>strlen<font color="black">(</font>_pa<font color="black">)</font><font color="black">+</font><font color="maroon">1</font><font color="black">)</font>,\
                StdCodeCvt<font color="black">(</font><font color="black">(</font>PWSTR<font color="black">)</font> _alloca<font color="black">(</font>_cvt<font color="black">*</font><font color="maroon">2</font><font color="black">)</font>, _pa, _cvt<font color="black">)</font><font color="black">)</font><font color="black">)</font>
        <font color="blue">#define</font> SSW2A<font color="black">(</font>pw<font color="black">)</font> <font color="black">(</font>\
            <font color="black">(</font><font color="black">(</font>_pw <font color="black">=</font> pw<font color="black">)</font> <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> ? NULL <font color="black">:</font> <font color="black">(</font>\
                _cvt <font color="black">=</font> <font color="black">(</font>wcslen<font color="black">(</font>_pw<font color="black">)</font><font color="black">+</font><font color="maroon">1</font><font color="black">)</font><font color="black">*</font><font color="maroon">2</font>,\
                StdCodeCvt<font color="black">(</font><font color="black">(</font>LPSTR<font color="black">)</font> _alloca<font color="black">(</font>_cvt<font color="black">)</font>, _pw, _cvt<font color="black">)</font><font color="black">)</font><font color="black">)</font>
    <font color="blue">#endif</font>

    <font color="blue">#define</font> SSA2CW<font color="black">(</font>pa<font color="black">)</font> <font color="black">(</font><font color="black">(</font>PCWSTR<font color="black">)</font>SSA2W<font color="black">(</font><font color="black">(</font>pa<font color="black">)</font><font color="black">)</font><font color="black">)</font>
    <font color="blue">#define</font> SSW2CA<font color="black">(</font>pw<font color="black">)</font> <font color="black">(</font><font color="black">(</font>PCSTR<font color="black">)</font>SSW2A<font color="black">(</font><font color="black">(</font>pw<font color="black">)</font><font color="black">)</font><font color="black">)</font>

    <font color="blue">#ifdef</font> UNICODE
        <font color="blue">#define</font> SST2A   SSW2A
        <font color="blue">#define</font> SSA2T   SSA2W
        <font color="blue">#define</font> SST2CA  SSW2CA
        <font color="blue">#define</font> SSA2CT  SSA2CW
        <font color="blue">inline</font> PWSTR    SST2W<font color="black">(</font>PTSTR p<font color="black">)</font>          <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PTSTR    SSW2T<font color="black">(</font>PWSTR p<font color="black">)</font>          <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PCWSTR   SST2CW<font color="black">(</font>PCTSTR p<font color="black">)</font>        <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PCTSTR   SSW2CT<font color="black">(</font>PCWSTR p<font color="black">)</font>        <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
    <font color="blue">#else</font>
        <font color="blue">#define</font> SST2W   SSA2W
        <font color="blue">#define</font> SSW2T   SSW2A
        <font color="blue">#define</font> SST2CW  SSA2CW
        <font color="blue">#define</font> SSW2CT  SSW2CA
        <font color="blue">inline</font> PSTR     SST2A<font color="black">(</font>PTSTR p<font color="black">)</font>          <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PTSTR    SSA2T<font color="black">(</font>PSTR p<font color="black">)</font>           <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PCSTR    SST2CA<font color="black">(</font>PCTSTR p<font color="black">)</font>        <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PCTSTR   SSA2CT<font color="black">(</font>PCSTR p<font color="black">)</font>         <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
    <font color="blue">#endif</font> <font color="green">// #ifdef UNICODE</font>

    <font color="blue">#if</font> defined<font color="black">(</font>UNICODE<font color="black">)</font>
    <font color="green">// in these cases the default (TCHAR) is the same as OLECHAR</font>
        <font color="blue">inline</font> PCOLESTR SST2COLE<font color="black">(</font>PCTSTR p<font color="black">)</font>      <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PCTSTR   SSOLE2CT<font color="black">(</font>PCOLESTR p<font color="black">)</font>    <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> POLESTR  SST2OLE<font color="black">(</font>PTSTR p<font color="black">)</font>        <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PTSTR    SSOLE2T<font color="black">(</font>POLESTR p<font color="black">)</font>      <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
    <font color="blue">#elif</font> defined<font color="black">(</font>OLE2ANSI<font color="black">)</font>
    <font color="green">// in these cases the default (TCHAR) is the same as OLECHAR</font>
        <font color="blue">inline</font> PCOLESTR SST2COLE<font color="black">(</font>PCTSTR p<font color="black">)</font>      <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PCTSTR   SSOLE2CT<font color="black">(</font>PCOLESTR p<font color="black">)</font>    <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> POLESTR  SST2OLE<font color="black">(</font>PTSTR p<font color="black">)</font>        <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PTSTR    SSOLE2T<font color="black">(</font>POLESTR p<font color="black">)</font>      <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
    <font color="blue">#else</font>
        <font color="green">//CharNextW doesn't work on Win95 so we use this</font>
        <font color="blue">#define</font> SST2COLE<font color="black">(</font>pa<font color="black">)</font>    SSA2CW<font color="black">(</font><font color="black">(</font>pa<font color="black">)</font><font color="black">)</font>
        <font color="blue">#define</font> SST2OLE<font color="black">(</font>pa<font color="black">)</font>     SSA2W<font color="black">(</font><font color="black">(</font>pa<font color="black">)</font><font color="black">)</font>
        <font color="blue">#define</font> SSOLE2CT<font color="black">(</font>po<font color="black">)</font>    SSW2CA<font color="black">(</font><font color="black">(</font>po<font color="black">)</font><font color="black">)</font>
        <font color="blue">#define</font> SSOLE2T<font color="black">(</font>po<font color="black">)</font>     SSW2A<font color="black">(</font><font color="black">(</font>po<font color="black">)</font><font color="black">)</font>
    <font color="blue">#endif</font>

    <font color="blue">#ifdef</font> OLE2ANSI
        <font color="blue">#define</font> SSW2OLE     SSW2A
        <font color="blue">#define</font> SSOLE2W     SSA2W
        <font color="blue">#define</font> SSW2COLE    SSW2CA
        <font color="blue">#define</font> SSOLE2CW    SSA2CW
        <font color="blue">inline</font> POLESTR      SSA2OLE<font color="black">(</font>PSTR p<font color="black">)</font>     <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PSTR         SSOLE2A<font color="black">(</font>POLESTR p<font color="black">)</font>  <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PCOLESTR     SSA2COLE<font color="black">(</font>PCSTR p<font color="black">)</font>   <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PCSTR        SSOLE2CA<font color="black">(</font>PCOLESTR p<font color="black">)</font><font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
    <font color="blue">#else</font>
        <font color="blue">#define</font> SSA2OLE     SSA2W
        <font color="blue">#define</font> SSOLE2A     SSW2A
        <font color="blue">#define</font> SSA2COLE    SSA2CW
        <font color="blue">#define</font> SSOLE2CA    SSW2CA
        <font color="blue">inline</font> POLESTR      SSW2OLE<font color="black">(</font>PWSTR p<font color="black">)</font>    <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PWSTR        SSOLE2W<font color="black">(</font>POLESTR p<font color="black">)</font>  <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PCOLESTR     SSW2COLE<font color="black">(</font>PCWSTR p<font color="black">)</font>  <font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
        <font color="blue">inline</font> PCWSTR       SSOLE2CW<font color="black">(</font>PCOLESTR p<font color="black">)</font><font color="black">{</font> <font color="blue">return</font> p; <font color="black">}</font>
    <font color="blue">#endif</font>

    <font color="green">// Above we've defined macros that look like MS' but all have</font>
    <font color="green">// an 'SS' prefix.  Now we need the real macros.  We'll either</font>
    <font color="green">// get them from the macros above or from MFC/ATL.  If</font>
    <font color="green">// SS_NO_CONVERSION is #defined, we'll forgo them</font>

    <font color="blue">#ifndef</font> SS_NO_CONVERSION

        <font color="blue">#if</font> defined <font color="black">(</font>USES_CONVERSION<font color="black">)</font>

            <font color="blue">#define</font> _NO_STDCONVERSION   <font color="green">// just to be consistent</font>

        <font color="blue">#else</font>

            <font color="blue">#ifdef</font> _MFC_VER

                <font color="blue">#include</font> <font color="maroon">&#60;afxconv.h&#62;</font>
                <font color="blue">#define</font> _NO_STDCONVERSION <font color="green">// just to be consistent</font>

            <font color="blue">#else</font>

                <font color="blue">#define</font> USES_CONVERSION SSCVT
                <font color="blue">#define</font> A2CW            SSA2CW
                <font color="blue">#define</font> W2CA            SSW2CA
                <font color="blue">#define</font> T2A             SST2A
                <font color="blue">#define</font> A2T             SSA2T
                <font color="blue">#define</font> T2W             SST2W
                <font color="blue">#define</font> W2T             SSW2T
                <font color="blue">#define</font> T2CA            SST2CA
                <font color="blue">#define</font> A2CT            SSA2CT
                <font color="blue">#define</font> T2CW            SST2CW
                <font color="blue">#define</font> W2CT            SSW2CT
                <font color="blue">#define</font> ocslen          sslen
                <font color="blue">#define</font> ocscpy          sscpy
                <font color="blue">#define</font> T2COLE          SST2COLE
                <font color="blue">#define</font> OLE2CT          SSOLE2CT
                <font color="blue">#define</font> T2OLE           SST2COLE
                <font color="blue">#define</font> OLE2T           SSOLE2CT
                <font color="blue">#define</font> A2OLE           SSA2OLE
                <font color="blue">#define</font> OLE2A           SSOLE2A
                <font color="blue">#define</font> W2OLE           SSW2OLE
                <font color="blue">#define</font> OLE2W           SSOLE2W
                <font color="blue">#define</font> A2COLE          SSA2COLE
                <font color="blue">#define</font> OLE2CA          SSOLE2CA
                <font color="blue">#define</font> W2COLE          SSW2COLE
                <font color="blue">#define</font> OLE2CW          SSOLE2CW
        
            <font color="blue">#endif</font> <font color="green">// #ifdef _MFC_VER</font>
        <font color="blue">#endif</font> <font color="green">// #ifndef USES_CONVERSION</font>
    <font color="blue">#endif</font> <font color="green">// #ifndef SS_NO_CONVERSION</font>

    <font color="green">// Define ostring - generic name for NSP::basic_string&#60;OLECHAR&#62;</font>

    <font color="blue">#if</font> <font color="black">!</font>defined<font color="black">(</font>ostring<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font>defined<font color="black">(</font>OSTRING_DEFINED<font color="black">)</font>
        <font color="blue">typedef</font> NSP<font color="black">:</font><font color="black">:</font>basic_string<font color="black">&#60;</font>OLECHAR<font color="black">&#62;</font> ostring;
        <font color="blue">#define</font> OSTRING_DEFINED
    <font color="blue">#endif</font>

<font color="blue">#endif</font> <font color="green">// #ifndef SS_ANSI</font>

<font color="green">// Define tstring -- generic name for NSP::basic_string&#60;TCHAR&#62;</font>

<font color="blue">#if</font> <font color="black">!</font>defined<font color="black">(</font>tstring<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font>defined<font color="black">(</font>TSTRING_DEFINED<font color="black">)</font>
    <font color="blue">typedef</font> NSP<font color="black">:</font><font color="black">:</font>basic_string<font color="black">&#60;</font>TCHAR<font color="black">&#62;</font> tstring;
    <font color="blue">#define</font> TSTRING_DEFINED
<font color="blue">#endif</font>

<font color="green">// a very shorthand way of applying the fix for KB problem Q172398</font>
<font color="green">// (basic_string assignment bug)</font>

<font color="blue">#if</font> defined <font color="black">(</font> _MSC_VER <font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font> _MSC_VER <font color="black">&#60;</font> <font color="maroon">1200</font> <font color="black">)</font>
    <font color="blue">#define</font> Q172398<font color="black">(</font>x<font color="black">)</font> <font color="black">(</font>x<font color="black">)</font>.erase<font color="black">(</font><font color="black">)</font>
<font color="blue">#else</font>
    <font color="blue">#define</font> Q172398<font color="black">(</font>x<font color="black">)</font>
<font color="blue">#endif</font>

<font color="green">// =============================================================================</font>
<font color="green">// INLINE FUNCTIONS ON WHICH CSTDSTRING RELIES</font>
<font color="green">//</font>
<font color="green">// Usually for generic text mapping, we rely on preprocessor macro definitions</font>
<font color="green">// to map to string functions.  However the CStdStr&#60;&#62; template cannot use</font>
<font color="green">// macro-based generic text mappings because its character types do not get</font>
<font color="green">// resolved until template processing which comes AFTER macro processing.  In</font>
<font color="green">// other words, UNICODE is of little help to us in the CStdStr template</font>
<font color="green">//</font>
<font color="green">// Therefore, to keep the CStdStr declaration simple, we have these inline</font>
<font color="green">// functions.  The template calls them often.  Since they are inline (and NOT</font>
<font color="green">// exported when this is built as a DLL), they will probably be resolved away</font>
<font color="green">// to nothing. </font>
<font color="green">//</font>
<font color="green">// Without these functions, the CStdStr&#60;&#62; template would probably have to broken</font>
<font color="green">// out into two, almost identical classes.  Either that or it would be a huge,</font>
<font color="green">// convoluted mess, with tons of "if" statements all over the place checking the</font>
<font color="green">// size of template parameter CT.</font>
<font color="green">// </font>
<font color="green">// In several cases, you will see two versions of each function, with one</font>
<font color="green">// commented out.  The second version is the more portable, standard way of</font>
<font color="green">// doing things, while the first version is non-standard, but significantly</font>
<font color="green">// faster.  Uncomment whichever one suits your needs</font>
<font color="green">// =============================================================================</font>

<font color="green">// If they defined SS_NO_REFCOUNT, then we must convert all assignments</font>

<font color="blue">#ifdef</font> SS_NO_REFCOUNT
    <font color="blue">#define</font> SSREF<font color="black">(</font>x<font color="black">)</font> <font color="black">(</font>x<font color="black">)</font>.c_str<font color="black">(</font><font color="black">)</font>
<font color="blue">#else</font>
    <font color="blue">#define</font> SSREF<font color="black">(</font>x<font color="black">)</font> <font color="black">(</font>x<font color="black">)</font>
<font color="blue">#endif</font>

<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// strlen/wcslen wrappers</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="blue">#ifdef</font> SS_ANSI
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font> <font color="blue">inline</font> <font color="blue">long</font> sslen<font color="black">(</font><font color="blue">const</font> CT<font color="black">*</font> pT<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> NULL <font color="black">=</font><font color="black">=</font> pT ? <font color="maroon">0</font> <font color="black">:</font> NSP<font color="black">:</font><font color="black">:</font>char_traits<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>length<font color="black">(</font>pT<font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#else</font>
    <font color="blue">inline</font> size_t sslen<font color="black">(</font>PCSTR pA<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> NULL <font color="black">=</font><font color="black">=</font> pA ? <font color="maroon">0</font> <font color="black">:</font> strlen<font color="black">(</font>pA<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">inline</font> size_t sslen<font color="black">(</font>PCWSTR pW<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> NULL <font color="black">=</font><font color="black">=</font> pW ? <font color="maroon">0</font> <font color="black">:</font> wcslen<font color="black">(</font>pW<font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#endif</font>


<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// assignment functions -- assign "sSrc" to "sDst"</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="blue">#define</font> StrSizeType NSP<font color="black">:</font><font color="black">:</font>string<font color="black">:</font><font color="black">:</font>size_type
<font color="blue">inline</font> <font color="blue">void</font> ssasn<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> sDst, <font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> sSrc<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> sDst.c_str<font color="black">(</font><font color="black">)</font> <font color="black">!</font><font color="black">=</font> sSrc.c_str<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
    <font color="black">{</font>
        sDst.erase<font color="black">(</font><font color="black">)</font>;
        sDst.assign<font color="black">(</font>SSREF<font color="black">(</font>sSrc<font color="black">)</font><font color="black">)</font>;
    <font color="black">}</font>
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">void</font> ssasn<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> sDst, PCSTR pA<font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Watch out for NULLs, as always.</font>

    <font color="blue">if</font> <font color="black">(</font> NULL <font color="black">=</font><font color="black">=</font> pA <font color="black">)</font>
    <font color="black">{</font>
        sDst.erase<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font>

    <font color="green">// If pA actually points to part of sDst, we must NOT erase(), but</font>
    <font color="green">// rather take a substring</font>

    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> pA <font color="black">&#62;</font><font color="black">=</font> sDst.c_str<font color="black">(</font><font color="black">)</font> <font color="black">&</font><font color="black">&</font> pA <font color="black">&#60;</font><font color="black">=</font> sDst.c_str<font color="black">(</font><font color="black">)</font> <font color="black">+</font> sDst.size<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
    <font color="black">{</font>
        sDst <font color="black">=</font>sDst.substr<font color="black">(</font>static_cast<font color="black">&#60;</font>StrSizeType<font color="black">&#62;</font><font color="black">(</font>pA<font color="black">-</font>sDst.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">)</font>;
    <font color="black">}</font>

    <font color="green">// Otherwise (most cases) apply the assignment bug fix, if applicable</font>
    <font color="green">// and do the assignment</font>

    <font color="blue">else</font>
    <font color="black">{</font>
        Q172398<font color="black">(</font>sDst<font color="black">)</font>;
        sDst.assign<font color="black">(</font>pA<font color="black">)</font>;
    <font color="black">}</font>
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">void</font> ssasn<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> sDst, <font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> sSrc<font color="black">)</font>
<font color="black">{</font>
<font color="blue">#ifdef</font> SS_ANSI
    <font color="blue">int</font> nLen    <font color="black">=</font> sSrc.size<font color="black">(</font><font color="black">)</font>;
    sDst.resize<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>;
    sDst.resize<font color="black">(</font>nLen<font color="black">)</font>;
    StdCodeCvt<font color="black">(</font>const_cast<font color="black">&#60;</font>NSP<font color="black">:</font><font color="black">:</font>string<font color="black">:</font><font color="black">:</font>pointer<font color="black">&#62;</font><font color="black">(</font>sDst.data<font color="black">(</font><font color="black">)</font><font color="black">)</font>,
               sSrc.c_str<font color="black">(</font><font color="black">)</font>,
               nLen<font color="black">)</font>;
<font color="blue">#else</font>
    SSCVT;
    sDst.assign<font color="black">(</font>SSW2CA<font color="black">(</font>sSrc.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">)</font>;
<font color="blue">#endif</font>
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">void</font> ssasn<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> sDst, PCWSTR pW<font color="black">)</font>
<font color="black">{</font>
<font color="blue">#ifdef</font> SS_ANSI
    <font color="blue">int</font> nLen    <font color="black">=</font> sslen<font color="black">(</font>pW<font color="black">)</font>;
    sDst.resize<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>;
    sDst.resize<font color="black">(</font>nLen<font color="black">)</font>;
    StdCodeCvt<font color="black">(</font>const_cast<font color="black">&#60;</font>NSP<font color="black">:</font><font color="black">:</font>string<font color="black">:</font><font color="black">:</font>pointer<font color="black">&#62;</font><font color="black">(</font>sDst.data<font color="black">(</font><font color="black">)</font><font color="black">)</font>, pW, nLen<font color="black">)</font>;
<font color="blue">#else</font>
    SSCVT;
    sDst.assign<font color="black">(</font>pW ? SSW2CA<font color="black">(</font>pW<font color="black">)</font> <font color="black">:</font> <font color="maroon">""</font><font color="black">)</font>;
<font color="blue">#endif</font>
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">void</font> ssasn<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> sDst, <font color="blue">const</font> <font color="blue">int</font> nNull<font color="black">)</font>
<font color="black">{</font>
    ASSERT<font color="black">(</font>nNull<font color="black">=</font><font color="black">=</font>NULL<font color="black">)</font>;
    sDst.assign<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>;
<font color="black">}</font>   
<font color="blue">inline</font> <font color="blue">void</font> ssasn<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> sDst, <font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> sSrc<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> sDst.c_str<font color="black">(</font><font color="black">)</font> <font color="black">!</font><font color="black">=</font> sSrc.c_str<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
    <font color="black">{</font>
        sDst.erase<font color="black">(</font><font color="black">)</font>;
        sDst.assign<font color="black">(</font>SSREF<font color="black">(</font>sSrc<font color="black">)</font><font color="black">)</font>;
    <font color="black">}</font>
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">void</font> ssasn<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> sDst, PCWSTR pW<font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Watch out for NULLs, as always.</font>

    <font color="blue">if</font> <font color="black">(</font> NULL <font color="black">=</font><font color="black">=</font> pW <font color="black">)</font>
    <font color="black">{</font>
        sDst.erase<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font>

    <font color="green">// If pW actually points to part of sDst, we must NOT erase(), but</font>
    <font color="green">// rather take a substring</font>

    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> pW <font color="black">&#62;</font><font color="black">=</font> sDst.c_str<font color="black">(</font><font color="black">)</font> <font color="black">&</font><font color="black">&</font> pW <font color="black">&#60;</font><font color="black">=</font> sDst.c_str<font color="black">(</font><font color="black">)</font> <font color="black">+</font> sDst.size<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
    <font color="black">{</font>
        sDst <font color="black">=</font> sDst.substr<font color="black">(</font>static_cast<font color="black">&#60;</font>StrSizeType<font color="black">&#62;</font><font color="black">(</font>pW<font color="black">-</font>sDst.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">)</font>;
    <font color="black">}</font>

    <font color="green">// Otherwise (most cases) apply the assignment bug fix, if applicable</font>
    <font color="green">// and do the assignment</font>

    <font color="blue">else</font>
    <font color="black">{</font>
        Q172398<font color="black">(</font>sDst<font color="black">)</font>;
        sDst.assign<font color="black">(</font>pW<font color="black">)</font>;
    <font color="black">}</font>
<font color="black">}</font>
<font color="blue">#undef</font> StrSizeType
<font color="blue">inline</font> <font color="blue">void</font> ssasn<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> sDst, <font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> sSrc<font color="black">)</font>
<font color="black">{</font>
<font color="blue">#ifdef</font> SS_ANSI
    <font color="blue">int</font> nLen    <font color="black">=</font> sSrc.size<font color="black">(</font><font color="black">)</font>;
    sDst.resize<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>;
    sDst.resize<font color="black">(</font>nLen<font color="black">)</font>;
    StdCodeCvt<font color="black">(</font>const_cast<font color="black">&#60;</font>NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">:</font><font color="black">:</font>pointer<font color="black">&#62;</font><font color="black">(</font>sDst.data<font color="black">(</font><font color="black">)</font><font color="black">)</font>,
                 sSrc.c_str<font color="black">(</font><font color="black">)</font>,
                 nLen<font color="black">)</font>;
<font color="blue">#else</font>
    SSCVT;
    sDst.assign<font color="black">(</font>SSA2CW<font color="black">(</font>sSrc.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">)</font>;
<font color="blue">#endif</font>
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">void</font> ssasn<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> sDst, PCSTR pA<font color="black">)</font>
<font color="black">{</font>
<font color="blue">#ifdef</font> SS_ANSI
    <font color="blue">int</font> nLen    <font color="black">=</font> sslen<font color="black">(</font>pA<font color="black">)</font>;
    sDst.resize<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>;
    sDst.resize<font color="black">(</font>nLen<font color="black">)</font>;
    StdCodeCvt<font color="black">(</font>const_cast<font color="black">&#60;</font>NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">:</font><font color="black">:</font>pointer<font color="black">&#62;</font><font color="black">(</font>sDst.data<font color="black">(</font><font color="black">)</font><font color="black">)</font>, pA, nLen<font color="black">)</font>;
<font color="blue">#else</font>
    SSCVT;
    sDst.assign<font color="black">(</font>pA ? SSA2CW<font color="black">(</font>pA<font color="black">)</font> <font color="black">:</font> L<font color="maroon">""</font><font color="black">)</font>;
<font color="blue">#endif</font>
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">void</font> ssasn<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> sDst, <font color="blue">const</font> <font color="blue">int</font> nNull<font color="black">)</font>
<font color="black">{</font>
    ASSERT<font color="black">(</font>nNull<font color="black">=</font><font color="black">=</font>NULL<font color="black">)</font>;
    sDst.assign<font color="black">(</font>L<font color="maroon">""</font><font color="black">)</font>;
<font color="black">}</font>


<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// string object concatenation -- add second argument to first</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="blue">inline</font> <font color="blue">void</font> ssadd<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> sDst, <font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> sSrc<font color="black">)</font>
<font color="black">{</font>
<font color="blue">#ifdef</font> SS_ANSI
    <font color="blue">int</font> nLen    <font color="black">=</font> sSrc.size<font color="black">(</font><font color="black">)</font>;
    sDst.resize<font color="black">(</font>sDst.size<font color="black">(</font><font color="black">)</font> <font color="black">+</font> nLen<font color="black">)</font>;
    StdCodeCvt<font color="black">(</font>const_cast<font color="black">&#60;</font>NSP<font color="black">:</font><font color="black">:</font>string<font color="black">:</font><font color="black">:</font>pointer<font color="black">&#62;</font><font color="black">(</font>sDst.data<font color="black">(</font><font color="black">)</font><font color="black">+</font>nLen<font color="black">)</font>,
               sSrc.c_str<font color="black">(</font><font color="black">)</font>,
               nLen<font color="black">)</font>;
<font color="blue">#else</font>
    SSCVT; 
    sDst.append<font color="black">(</font>SSW2CA<font color="black">(</font>sSrc.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">)</font>; 
<font color="blue">#endif</font>
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">void</font> ssadd<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> sDst, <font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> sSrc<font color="black">)</font>
<font color="black">{</font> 
    sDst.append<font color="black">(</font>sSrc.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">void</font> ssadd<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> sDst, PCWSTR pW<font color="black">)</font>
<font color="black">{</font>
<font color="blue">#ifdef</font> SS_ANSI
    <font color="blue">int</font> nLen    <font color="black">=</font> sslen<font color="black">(</font>pW<font color="black">)</font>;
    sDst.resize<font color="black">(</font>sDst.size<font color="black">(</font><font color="black">)</font> <font color="black">+</font> nLen<font color="black">)</font>;
    StdCodeCvt<font color="black">(</font>const_cast<font color="black">&#60;</font>NSP<font color="black">:</font><font color="black">:</font>string<font color="black">:</font><font color="black">:</font>pointer<font color="black">&#62;</font><font color="black">(</font>sDst.data<font color="black">(</font><font color="black">)</font><font color="black">+</font>nLen<font color="black">)</font>, pW, nLen<font color="black">)</font>;
<font color="blue">#else</font>
    SSCVT;
    <font color="blue">if</font> <font color="black">(</font> NULL <font color="black">!</font><font color="black">=</font> pW <font color="black">)</font>
        sDst.append<font color="black">(</font>SSW2CA<font color="black">(</font>pW<font color="black">)</font><font color="black">)</font>; 
<font color="blue">#endif</font>
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">void</font> ssadd<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> sDst, PCSTR pA<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> pA <font color="black">)</font>
        sDst.append<font color="black">(</font>pA<font color="black">)</font>; 
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">void</font> ssadd<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> sDst, <font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> sSrc<font color="black">)</font>
<font color="black">{</font>
    sDst.append<font color="black">(</font>sSrc.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">void</font> ssadd<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> sDst, <font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> sSrc<font color="black">)</font>
<font color="black">{</font>
<font color="blue">#ifdef</font> SS_ANSI
    <font color="blue">int</font> nLen    <font color="black">=</font> sSrc.size<font color="black">(</font><font color="black">)</font>;
    sDst.resize<font color="black">(</font>sDst.size<font color="black">(</font><font color="black">)</font> <font color="black">+</font> nLen<font color="black">)</font>;
    StdCodeCvt<font color="black">(</font>const_cast<font color="black">&#60;</font>NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">:</font><font color="black">:</font>pointer<font color="black">&#62;</font><font color="black">(</font>sDst.data<font color="black">(</font><font color="black">)</font><font color="black">+</font>nLen<font color="black">)</font>,
                 sSrc.c_str<font color="black">(</font><font color="black">)</font>,
                 nLen<font color="black">)</font>;
<font color="blue">#else</font>
    SSCVT;
    sDst.append<font color="black">(</font>SSA2CW<font color="black">(</font>sSrc.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">)</font>;
<font color="blue">#endif</font>
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">void</font> ssadd<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> sDst, PCSTR pA<font color="black">)</font>
<font color="black">{</font>
<font color="blue">#ifdef</font> SS_ANSI
    <font color="blue">int</font> nLen    <font color="black">=</font> sslen<font color="black">(</font>pA<font color="black">)</font>;
    sDst.resize<font color="black">(</font>sDst.size<font color="black">(</font><font color="black">)</font> <font color="black">+</font> nLen<font color="black">)</font>;
    StdCodeCvt<font color="black">(</font>const_cast<font color="black">&#60;</font>NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">:</font><font color="black">:</font>pointer<font color="black">&#62;</font><font color="black">(</font>sDst.data<font color="black">(</font><font color="black">)</font><font color="black">+</font>nLen<font color="black">)</font>, pA, nLen<font color="black">)</font>;
<font color="blue">#else</font>
    SSCVT;
    <font color="blue">if</font> <font color="black">(</font> NULL <font color="black">!</font><font color="black">=</font> pA <font color="black">)</font>
        sDst.append<font color="black">(</font>SSA2CW<font color="black">(</font>pA<font color="black">)</font><font color="black">)</font>;
<font color="blue">#endif</font>
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">void</font> ssadd<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> sDst, PCWSTR pW<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> pW <font color="black">)</font>
        sDst.append<font color="black">(</font>pW<font color="black">)</font>;
<font color="black">}</font>


<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// comparison (case insensitive )</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="blue">#ifdef</font> SS_ANSI
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font> <font color="blue">int</font> ssicmp<font color="black">(</font><font color="blue">const</font> CT<font color="black">*</font> pA1, <font color="blue">const</font> CT<font color="black">*</font> pA2<font color="black">)</font>
    <font color="black">{</font>
        NSP<font color="black">:</font><font color="black">:</font>locale loc;
        <font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>ctype<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> ct <font color="black">=</font> SS_USE_FACET<font color="black">(</font>loc, NSP<font color="black">:</font><font color="black">:</font>ctype<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">)</font>;
        CT f;
        CT l;

            <font color="blue">do</font> 
            <font color="black">{</font>
                f <font color="black">=</font> ct.tolower<font color="black">(</font><font color="black">*</font><font color="black">(</font>pA1<font color="black">+</font><font color="black">+</font><font color="black">)</font><font color="black">)</font>;
                l <font color="black">=</font> ct.tolower<font color="black">(</font><font color="black">*</font><font color="black">(</font>pA2<font color="black">+</font><font color="black">+</font><font color="black">)</font><font color="black">)</font>;
            <font color="black">}</font> <font color="blue">while</font> <font color="black">(</font> <font color="black">(</font>f<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font>f <font color="black">=</font><font color="black">=</font> l<font color="black">)</font> <font color="black">)</font>;

        <font color="blue">return</font> <font color="black">(</font><font color="blue">int</font><font color="black">)</font><font color="black">(</font>f <font color="black">-</font>l<font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#else</font>
    <font color="blue">#ifdef</font> _MBCS
        <font color="blue">inline</font> <font color="blue">long</font> sscmp<font color="black">(</font>PCSTR pA1, PCSTR pA2<font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">return</font> _mbscmp<font color="black">(</font><font color="black">(</font>PCUSTR<font color="black">)</font>pA1, <font color="black">(</font>PCUSTR<font color="black">)</font>pA2<font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">inline</font> <font color="blue">long</font> ssicmp<font color="black">(</font>PCSTR pA1, PCSTR pA2<font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">return</font> _mbsicmp<font color="black">(</font><font color="black">(</font>PCUSTR<font color="black">)</font>pA1, <font color="black">(</font>PCUSTR<font color="black">)</font>pA2<font color="black">)</font>;
        <font color="black">}</font>
    <font color="blue">#else</font>
        <font color="blue">inline</font> <font color="blue">long</font> sscmp<font color="black">(</font>PCSTR pA1, PCSTR pA2<font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">return</font> strcmp<font color="black">(</font>pA1, pA2<font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">inline</font> <font color="blue">long</font> ssicmp<font color="black">(</font>PCSTR pA1, PCSTR pA2<font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">return</font> _stricmp<font color="black">(</font>pA1, pA2<font color="black">)</font>;
        <font color="black">}</font>
    <font color="blue">#endif</font>
    <font color="blue">inline</font> <font color="blue">long</font> sscmp<font color="black">(</font>PCWSTR pW1, PCWSTR pW2<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> wcscmp<font color="black">(</font>pW1, pW2<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">inline</font> <font color="blue">long</font> ssicmp<font color="black">(</font>PCWSTR pW1, PCWSTR pW2<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> _wcsicmp<font color="black">(</font>pW1, pW2<font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#endif</font>

<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// isspace() equivalents</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="blue">#ifdef</font> SS_ANSI
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font> <font color="blue">bool</font> ssisp<font color="black">(</font>CT t<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> NSP<font color="black">:</font><font color="black">:</font>isspace<font color="black">(</font>t, NSP<font color="black">:</font><font color="black">:</font>locale<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#else</font>
    <font color="blue">inline</font> <font color="blue">bool</font> ssisp<font color="black">(</font><font color="blue">char</font> t<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> isspace<font color="black">(</font>t<font color="black">)</font> <font color="black">!</font><font color="black">=</font> <font color="maroon">0</font>;
    <font color="black">}</font>
    <font color="blue">inline</font> <font color="blue">bool</font> ssisp<font color="black">(</font>wchar_t t<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> iswspace<font color="black">(</font>t<font color="black">)</font> <font color="black">!</font><font color="black">=</font> <font color="maroon">0</font>;
    <font color="black">}</font>
<font color="blue">#endif</font>

<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// Uppercase/Lowercase conversion functions</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="blue">#ifdef</font> SS_ANSI
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font> <font color="blue">void</font> sslwr<font color="black">(</font>CT<font color="black">*</font> pT, size_t nLen<font color="black">)</font>
    <font color="black">{</font>
        SS_USE_FACET<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>locale<font color="black">(</font><font color="black">)</font>, NSP<font color="black">:</font><font color="black">:</font>ctype<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">)</font>.tolower<font color="black">(</font>pT, pT<font color="black">+</font>nLen<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font> <font color="blue">void</font> ssupr<font color="black">(</font>CT<font color="black">*</font> pT<font color="black">)</font>
    <font color="black">{</font>
        SS_USE_FACET<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>locale<font color="black">(</font><font color="black">)</font>, NSP<font color="black">:</font><font color="black">:</font>ctype<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">)</font>.toupper<font color="black">(</font>pT, pT<font color="black">+</font>nLen<font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#else</font>  <font color="green">// #else we must be on Win32</font>
    <font color="blue">#ifdef</font> _MBCS
        <font color="blue">inline</font> <font color="blue">void</font> ssupr<font color="black">(</font>PSTR pA, size_t <font color="green">/*nLen*/</font><font color="black">)</font>
        <font color="black">{</font>
            _mbsupr<font color="black">(</font><font color="black">(</font>PUSTR<font color="black">)</font>pA<font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">inline</font> <font color="blue">void</font> sslwr<font color="black">(</font>PSTR pA, size_t <font color="green">/*nLen*/</font><font color="black">)</font>
        <font color="black">{</font>
            _mbslwr<font color="black">(</font><font color="black">(</font>PUSTR<font color="black">)</font>pA<font color="black">)</font>;
        <font color="black">}</font>
    <font color="blue">#else</font>
        <font color="blue">inline</font> <font color="blue">void</font> ssupr<font color="black">(</font>PSTR pA, size_t <font color="green">/*nLen*/</font><font color="black">)</font>
        <font color="black">{</font>
            _strupr<font color="black">(</font>pA<font color="black">)</font>; 
        <font color="black">}</font>
        <font color="blue">inline</font> <font color="blue">void</font> sslwr<font color="black">(</font>PSTR pA, size_t <font color="green">/*nLen*/</font><font color="black">)</font>
        <font color="black">{</font>
            _strlwr<font color="black">(</font>pA<font color="black">)</font>;
        <font color="black">}</font>
    <font color="blue">#endif</font>
    <font color="blue">inline</font> <font color="blue">void</font> ssupr<font color="black">(</font>PWSTR pW, size_t <font color="green">/*nLen*/</font><font color="black">)</font>    
    <font color="black">{</font>
        _wcsupr<font color="black">(</font>pW<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">inline</font> <font color="blue">void</font> sslwr<font color="black">(</font>PWSTR pW, size_t <font color="green">/*nLen*/</font><font color="black">)</font>    
    <font color="black">{</font>
        _wcslwr<font color="black">(</font>pW<font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#endif</font> <font color="green">// #ifdef SS_ANSI</font>

<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">//  vsprintf/vswprintf or _vsnprintf/_vsnwprintf equivalents.  In standard</font>
<font color="green">//  builds we can't use _vsnprintf/_vsnwsprintf because they're MS extensions.</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="blue">#ifdef</font> SS_ANSI
    <font color="blue">inline</font> <font color="blue">int</font> ssvsprintf<font color="black">(</font>PSTR pA, size_t <font color="green">/*nCount*/</font>, PCSTR pFmtA, va_list vl<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> vsprintf<font color="black">(</font>pA, pFmtA, vl<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">inline</font> <font color="blue">int</font> ssvsprintf<font color="black">(</font>PWSTR pW, size_t nCount, PCWSTR pFmtW, va_list vl<font color="black">)</font>
    <font color="black">{</font>
    <font color="blue">#ifdef</font> __MWERKS__
        <font color="blue">return</font> vswprintf<font color="black">(</font>pW, nCount, pFmtW, vl<font color="black">)</font>;
    <font color="blue">#else</font>
        nCount;
        <font color="blue">return</font> vswprintf<font color="black">(</font>pW, pFmtW, vl<font color="black">)</font>;
    <font color="blue">#endif</font>
    <font color="black">}</font>
    <font color="blue">inline</font> <font color="blue">int</font> ssvsprintf<font color="black">(</font>PWSTR pW, PCWSTR pFmtW, va_list vl<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> vswprintf<font color="black">(</font>pW, pFmtW, vl<font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#else</font>
    <font color="blue">inline</font> <font color="blue">int</font>  ssnprintf<font color="black">(</font>PSTR pA, size_t nCount, PCSTR pFmtA, va_list vl<font color="black">)</font>
    <font color="black">{</font> 
        <font color="blue">return</font> _vsnprintf<font color="black">(</font>pA, nCount, pFmtA, vl<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">inline</font> <font color="blue">int</font>  ssnprintf<font color="black">(</font>PWSTR pW, size_t nCount, PCWSTR pFmtW, va_list vl<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> _vsnwprintf<font color="black">(</font>pW, nCount, pFmtW, vl<font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#endif</font>


<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// Type safe, overloaded ::LoadString wrappers</font>
<font color="green">// There is no equivalent of these in non-Win32-specific builds.</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="blue">#ifdef</font> SS_ANSI
<font color="blue">#else</font>
    <font color="blue">inline</font> <font color="blue">int</font> ssload<font color="black">(</font>HMODULE hInst, UINT uId, PSTR pBuf, <font color="blue">int</font> nMax<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> <font color="black">:</font><font color="black">:</font>LoadStringA<font color="black">(</font>hInst, uId, pBuf, nMax<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">inline</font> <font color="blue">int</font> ssload<font color="black">(</font>HMODULE hInst, UINT uId, PWSTR pBuf, <font color="blue">int</font> nMax<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> <font color="black">:</font><font color="black">:</font>LoadStringW<font color="black">(</font>hInst, uId, pBuf, nMax<font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#endif</font>

<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// Collation wrappers</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="blue">#ifdef</font> SS_ANSI
    <font color="blue">template</font> <font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font> <font color="blue">int</font> sscoll<font color="black">(</font><font color="blue">const</font> CT<font color="black">*</font> sz1, <font color="blue">int</font> nLen1, <font color="blue">const</font> CT<font color="black">*</font> sz2, <font color="blue">int</font> nLen2<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>collate<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> coll <font color="black">=</font>
            SS_USE_FACET<font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>locale<font color="black">(</font><font color="black">)</font>, NSP<font color="black">:</font><font color="black">:</font>collate<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">)</font>;
        <font color="blue">return</font> coll.compare<font color="black">(</font>sz1, sz1<font color="black">+</font>nLen1, sz2, sz2<font color="black">+</font>nLen2<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">template</font> <font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font> <font color="blue">int</font> ssicoll<font color="black">(</font><font color="blue">const</font> CT<font color="black">*</font> sz1, <font color="blue">int</font> nLen1, <font color="blue">const</font> CT<font color="black">*</font> sz2, <font color="blue">int</font> nLen2<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>locale loc;
        <font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>collate<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> coll <font color="black">=</font> SS_USE_FACET<font color="black">(</font>loc, NSP<font color="black">:</font><font color="black">:</font>collate<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">)</font>;

        NSP<font color="black">:</font><font color="black">:</font>collate<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>string_type s1<font color="black">(</font>sz1<font color="black">)</font>;
        NSP<font color="black">:</font><font color="black">:</font>collate<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>string_type s2<font color="black">(</font>sz2<font color="black">)</font>;

        sslwr<font color="black">(</font>const_cast<font color="black">&#60;</font>CT<font color="black">*</font><font color="black">&#62;</font><font color="black">(</font>s1.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>, nLen1<font color="black">)</font>;
        sslwr<font color="black">(</font>const_cast<font color="black">&#60;</font>CT<font color="black">*</font><font color="black">&#62;</font><font color="black">(</font>s2.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>, nLen2<font color="black">)</font>;
        <font color="blue">return</font> coll.compare<font color="black">(</font>s1.c_str<font color="black">(</font><font color="black">)</font>, s1.c_str<font color="black">(</font><font color="black">)</font><font color="black">+</font>nLen1,
                            s2.c_str<font color="black">(</font><font color="black">)</font>, s2.c_str<font color="black">(</font><font color="black">)</font><font color="black">+</font>nLen2<font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#else</font>
    <font color="blue">#ifdef</font> _MBCS
        <font color="blue">inline</font> <font color="blue">int</font> sscoll<font color="black">(</font>PCSTR sz1, <font color="blue">int</font> <font color="green">/*nLen1*/</font>, PCSTR sz2, <font color="blue">int</font> <font color="green">/*nLen2*/</font><font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">return</font> _mbscoll<font color="black">(</font><font color="black">(</font>PCUSTR<font color="black">)</font>sz1, <font color="black">(</font>PCUSTR<font color="black">)</font>sz2<font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">inline</font> <font color="blue">int</font> ssicoll<font color="black">(</font>PCSTR sz1, <font color="blue">int</font> <font color="green">/*nLen1*/</font>, PCSTR sz2, <font color="blue">int</font> <font color="green">/*nLen2*/</font><font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">return</font> _mbsicoll<font color="black">(</font><font color="black">(</font>PCUSTR<font color="black">)</font>sz1, <font color="black">(</font>PCUSTR<font color="black">)</font>sz2<font color="black">)</font>;
        <font color="black">}</font>
    <font color="blue">#else</font>
        <font color="blue">inline</font> <font color="blue">int</font> sscoll<font color="black">(</font>PCSTR sz1, <font color="blue">int</font> <font color="green">/*nLen1*/</font>, PCSTR sz2, <font color="blue">int</font> <font color="green">/*nLen2*/</font><font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">return</font> strcoll<font color="black">(</font>sz1, sz2<font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">inline</font> <font color="blue">int</font> ssicoll<font color="black">(</font>PCSTR sz1, <font color="blue">int</font> <font color="green">/*nLen1*/</font>, PCSTR sz2, <font color="blue">int</font> <font color="green">/*nLen2*/</font><font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">return</font> _stricoll<font color="black">(</font>sz1, sz2<font color="black">)</font>;
        <font color="black">}</font>
    <font color="blue">#endif</font>
    <font color="blue">inline</font> <font color="blue">int</font> sscoll<font color="black">(</font>PCWSTR sz1, <font color="blue">int</font> <font color="green">/*nLen1*/</font>, PCWSTR sz2, <font color="blue">int</font> <font color="green">/*nLen2*/</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> wcscoll<font color="black">(</font>sz1, sz2<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">inline</font> <font color="blue">int</font> ssicoll<font color="black">(</font>PCWSTR sz1, <font color="blue">int</font> <font color="green">/*nLen1*/</font>, PCWSTR sz2, <font color="blue">int</font> <font color="green">/*nLen2*/</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> _wcsicoll<font color="black">(</font>sz1, sz2<font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#endif</font>

<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// FormatMessage equivalents.  Needed because I added a CString facade</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="blue">#ifdef</font> SS_ANSI
<font color="blue">#else</font>
    <font color="blue">inline</font> DWORD ssfmtmsg<font color="black">(</font>DWORD dwFlags, LPCVOID pSrc, DWORD dwMsgId,
                          DWORD dwLangId, PSTR pBuf, DWORD nSize,
                          va_list<font color="black">*</font> vlArgs<font color="black">)</font>
    <font color="black">{</font> 
        <font color="blue">return</font> FormatMessageA<font color="black">(</font>dwFlags, pSrc, dwMsgId, dwLangId,
                              pBuf, nSize,vlArgs<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">inline</font> DWORD ssfmtmsg<font color="black">(</font>DWORD dwFlags, LPCVOID pSrc, DWORD dwMsgId,
                          DWORD dwLangId, PWSTR pBuf, DWORD nSize,
                          va_list<font color="black">*</font> vlArgs<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> FormatMessageW<font color="black">(</font>dwFlags, pSrc, dwMsgId, dwLangId,
                              pBuf, nSize,vlArgs<font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#endif</font>
 


<font color="green">// FUNCTION: sscpy.  Copies up to 'nMax' characters from pSrc to pDst.</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// FUNCTION:  sscpy</font>
<font color="green">//      static void sscpy(PSTR pDst, PCSTR pSrc, int nMax=0);</font>
<font color="green">//      static void sscpy(PWSTR pDst, PCWSTR pSrc, int nMax=0);</font>
<font color="green">//      static void sscpy(PWSTR pDst, PCSTR pSrc, int nMax=0);</font>
<font color="green">//      static void sscpy(PSTR pDst, PCWSTR pSrc, int nMax=0);</font>
<font color="green">//</font>
<font color="green">// DESCRIPTION:</font>
<font color="green">//      This function is very much (but not exactly) like strcpy.</font>
<font color="green">//      strcpy equivalents.  These are not inline because they're too big.</font>
<font color="green">//      When built as a DLL, we export them.  In previous versions of this</font>
<font color="green">//      class, these were the equivalent of the static member</font>
<font color="green">//      CStdString::CopyString with the destination and source args reversed.</font>
<font color="green">//</font>
<font color="green">//      These 3 overloads simplify copying one C-style string into another.</font>
<font color="green">//      The strings must NOT overlap</font>
<font color="green">//</font>
<font color="green">//      "Character" is expressed in terms of the destination string, not</font>
<font color="green">//      the source.  If no 'nMax' argument is supplied, then the number of</font>
<font color="green">//      characters copied will be sslen(pSrc).  A NULL terminator will</font>
<font color="green">//      also be added so pDst must actually be big enough to hold nMax+1</font>
<font color="green">//      characters.  The return value is the number of characters copied,</font>
<font color="green">//      not including the NULL terminator.</font>
<font color="green">//</font>
<font color="green">// PARAMETERS: </font>
<font color="green">//      pSrc - the string to be copied FROM.  May be a char based string, an</font>
<font color="green">//             MBCS string (in Win32 builds) or a wide string (wchar_t).</font>
<font color="green">//      pSrc - the string to be copied TO.  Also may be either MBCS or wide</font>
<font color="green">//      nMax - the maximum number of characters to be copied into szDest.  Note</font>
<font color="green">//             that this is expressed in whatever a "character" means to pDst.</font>
<font color="green">//             If pDst is a wchar_t type string than this will be the maximum</font>
<font color="green">//             number of wchar_ts that my be copied.  The pDst string must be</font>
<font color="green">//             large enough to hold least nMaxChars+1 characters.</font>
<font color="green">//             If the caller supplies no argument for nMax this is a signal to</font>
<font color="green">//             the routine to copy all the characters in pSrc, regardless of</font>
<font color="green">//             how long it is.</font>
<font color="green">//</font>
<font color="green">// RETURN VALUE: none</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="blue">template</font> <font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">int</font> sscpysame<font color="black">(</font>CT<font color="black">*</font> pDst, <font color="blue">const</font> CT<font color="black">*</font> pSrc, <font color="blue">int</font> nMax<font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">int</font> nSrcLen <font color="black">=</font> NULL <font color="black">=</font><font color="black">=</font> pSrc ? <font color="maroon">0</font> <font color="black">:</font> sslen<font color="black">(</font>pSrc<font color="black">)</font>;
    <font color="blue">int</font> nChars <font color="black">=</font> <font color="black">(</font> nMax <font color="black">&#62;</font><font color="black">=</font> <font color="maroon">0</font> ? SSMIN<font color="black">(</font>nMax, nSrcLen<font color="black">)</font> <font color="black">:</font> nSrcLen <font color="black">)</font>;
<font color="green">//  memcpy(pDst, pSrc, nChars * sizeof(CT));</font>
    NSP<font color="black">:</font><font color="black">:</font>char_traits<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">(</font><font color="black">)</font>.copy<font color="black">(</font>pDst, pSrc, nChars <font color="black">*</font> <font color="blue">sizeof</font><font color="black">(</font>CT<font color="black">)</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> nChars <font color="black">&#62;</font> <font color="maroon">0</font> <font color="black">)</font>
        pDst<font color="black">[</font>nChars<font color="black">]</font>    <font color="black">=</font> <font color="maroon">'\0'</font>;

    <font color="blue">return</font> nChars;
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">int</font> sscpy<font color="black">(</font>PSTR pDst,  PCSTR pSrc, <font color="blue">int</font> nMax<font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> sscpysame<font color="black">(</font>pDst, pSrc, nMax<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">int</font> sscpy<font color="black">(</font>PWSTR pDst, PCWSTR pSrc, <font color="blue">int</font> nMax<font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> sscpysame<font color="black">(</font>pDst, pSrc, nMax<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">template</font><font color="black">&#60;</font>typename CT1, typename CT2<font color="black">&#62;</font>
<font color="blue">inline</font> <font color="blue">int</font> sscpydiff<font color="black">(</font>CT1<font color="black">*</font> pDst, <font color="blue">const</font> CT2<font color="black">*</font> pSrc, <font color="blue">int</font> nMax<font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">int</font> nSrcLen <font color="black">=</font> NULL <font color="black">=</font><font color="black">=</font> pSrc ? <font color="maroon">0</font> <font color="black">:</font> sslen<font color="black">(</font>pSrc<font color="black">)</font>;
    <font color="blue">int</font> nChars  <font color="black">=</font> nMax <font color="black">&#62;</font><font color="black">=</font> <font color="maroon">0</font> ? SSMIN<font color="black">(</font>nMax, nSrcLen<font color="black">)</font> <font color="black">:</font> nSrcLen;
    StdCodeCvt<font color="black">(</font>pDst, pSrc, nChars<font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> nChars <font color="black">&#62;</font> <font color="maroon">0</font> <font color="black">)</font>
        pDst<font color="black">[</font>nChars<font color="black">]</font>    <font color="black">=</font> <font color="maroon">'\0'</font>;

    <font color="blue">return</font> nChars;
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">int</font> sscpy<font color="black">(</font>PWSTR pDst, PCSTR  pSrc, <font color="blue">int</font> nMax<font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> sscpydiff<font color="black">(</font>pDst, pSrc, nMax<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">inline</font> <font color="blue">int</font> sscpy<font color="black">(</font>PSTR pDst, PCWSTR pSrc, <font color="blue">int</font> nMax<font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> sscpydiff<font color="black">(</font>pDst, pSrc, nMax<font color="black">)</font>;
<font color="black">}</font>


<font color="green">//          Now we can define the template (finally!)</font>
<font color="green">// =============================================================================</font>
<font color="green">// TEMPLATE: CStdStr</font>
<font color="green">//      template&#60;typename CT&#62; class CStdStr : public NSP::basic_string&#60;CT&#62;</font>
<font color="green">//</font>
<font color="green">// REMARKS:</font>
<font color="green">//      This template derives from basic_string&#60;CT&#62; and adds some MFC CString-</font>
<font color="green">//      like functionality</font>
<font color="green">//</font>
<font color="green">//      Basically, this is my attempt to make Standard C++ library strings as</font>
<font color="green">//      easy to use as the MFC CString class.</font>
<font color="green">//</font>
<font color="green">//      Note that although this is a template, it makes the assumption that the</font>
<font color="green">//      template argument (CT, the character type) is either char or wchar_t.  </font>
<font color="green">// =============================================================================</font>

<font color="blue">#define</font> CStdStr _SS <font color="green">// avoid compiler warning 4786</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">class</font> CStdStr <font color="black">:</font> <font color="blue">public</font> NSP<font color="black">:</font><font color="black">:</font>basic_string<font color="black">&#60;</font>CT<font color="black">&#62;</font>
<font color="black">{</font>
    <font color="green">// Typedefs for shorter names.  Using these names also appears to help</font>
    <font color="green">// us avoid some ambiguities that otherwise arise on some platforms</font>

    <font color="blue">typedef</font> NSP<font color="black">:</font><font color="black">:</font>basic_string<font color="black">&#60;</font>CT<font color="black">&#62;</font>   MYBASE;  <font color="green">// my base class (string or wstring)</font>
    <font color="blue">typedef</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font>             MYTYPE;  <font color="green">// myself</font>
    <font color="blue">typedef</font> MYBASE<font color="black">:</font><font color="black">:</font>const_pointer   PCMYSTR; <font color="green">// PCSTR or PCWSTR </font>
    <font color="blue">typedef</font> MYBASE<font color="black">:</font><font color="black">:</font>pointer         PMYSTR;  <font color="green">// PSTR or PWSTR</font>
    <font color="blue">typedef</font> MYBASE<font color="black">:</font><font color="black">:</font>iterator        MYITER;  <font color="green">// my iterator type</font>
    <font color="blue">typedef</font> MYBASE<font color="black">:</font><font color="black">:</font>const_iterator  MYCITER; <font color="green">// you get the idea...</font>
    <font color="blue">typedef</font> MYBASE<font color="black">:</font><font color="black">:</font>size_type       MYSIZE;   
    <font color="blue">typedef</font> MYBASE<font color="black">:</font><font color="black">:</font>value_type      MYVAL; 
    <font color="blue">typedef</font> MYBASE<font color="black">:</font><font color="black">:</font>allocator_type  MYALLOC;
    

<font color="blue">public</font><font color="black">:</font>

    <font color="green">// constructors</font>

                            CStdStr<font color="black">(</font><font color="black">)</font>;
                            CStdStr<font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str<font color="black">)</font>;
                            CStdStr<font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> strA<font color="black">)</font>;
                            CStdStr<font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> strW<font color="black">)</font>;
                            CStdStr<font color="black">(</font>PCMYSTR pT, MYSIZE n<font color="black">)</font>;
                            CStdStr<font color="black">(</font>PCSTR pA<font color="black">)</font>;
                            CStdStr<font color="black">(</font>PCWSTR pW<font color="black">)</font>;
                            CStdStr<font color="black">(</font>MYCITER first, MYCITER last<font color="black">)</font>;
                            CStdStr<font color="black">(</font>MYSIZE nSize,
                                    MYVAL ch,
                                    <font color="blue">const</font> MYALLOC<font color="black">&</font> al<font color="black">=</font>MYALLOC<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
<font color="blue">#ifdef</font> SS_INC_COMDEF
                            CStdStr<font color="black">(</font><font color="blue">const</font> _bstr_t<font color="black">&</font> bstr<font color="black">)</font>;
<font color="blue">#endif</font>

    <font color="green">// assignment operators</font>

            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    <font color="blue">operator</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    <font color="blue">operator</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> strA<font color="black">)</font>; 
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    <font color="blue">operator</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> strW<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    <font color="blue">operator</font><font color="black">=</font><font color="black">(</font>PCSTR pT<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    <font color="blue">operator</font><font color="black">=</font><font color="black">(</font>PCWSTR pO<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    <font color="blue">operator</font><font color="black">=</font><font color="black">(</font>CT t<font color="black">)</font>;
<font color="blue">#ifdef</font> SS_INC_COMDEF
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    <font color="blue">operator</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> _bstr_t<font color="black">&</font> bstr<font color="black">)</font>;
<font color="blue">#endif</font>

    <font color="green">// These overloads are also needed to fix the MSVC assignment bug (only for</font>
    <font color="green">// MS' STL -- KB: Q172398). This bug was fixed in VC6 -- hence the macro</font>
    <font color="green">// *** Thanks to Pete The Plumber for catching this one ***</font>

<font color="blue">#if</font> <font color="black">(</font> defined<font color="black">(</font>_MSC_VER<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font> _MSC_VER <font color="black">&#60;</font> <font color="maroon">1200</font> <font color="black">)</font> <font color="black">)</font> <font color="black">|</font><font color="black">|</font> defined<font color="black">(</font>SS_NO_REFCOUNT<font color="black">)</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    assign<font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    assign<font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str,
                                   MYSIZE nStart,
                                   MYSIZE nChars<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    assign<font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>basic_string<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    assign<font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>basic_string<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str,
                                   MYSIZE nStart,
                                   MYSIZE nChars<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    assign<font color="black">(</font><font color="blue">const</font> CT<font color="black">*</font> pT, MYSIZE nChars<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    assign<font color="black">(</font>MYSIZE nChars, MYVAL val<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    assign<font color="black">(</font><font color="blue">const</font> CT<font color="black">*</font> pT<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    assign<font color="black">(</font>MYCITER iterFirst, MYCITER iterLast<font color="black">)</font>;
<font color="blue">#endif</font>

    <font color="green">// concatenation.</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    <font color="blue">operator</font><font color="black">+</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    <font color="blue">operator</font><font color="black">+</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> str<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    <font color="blue">operator</font><font color="black">+</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> str<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    <font color="blue">operator</font><font color="black">+</font><font color="black">=</font><font color="black">(</font>PCSTR pA<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    <font color="blue">operator</font><font color="black">+</font><font color="black">=</font><font color="black">(</font>PCWSTR pW<font color="black">)</font>;
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    <font color="blue">operator</font><font color="black">+</font><font color="black">=</font><font color="black">(</font>CT t<font color="black">)</font>;
<font color="blue">#ifdef</font> SS_INC_COMDEF
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    <font color="blue">operator</font><font color="black">+</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> _bstr_t<font color="black">&</font> bstr<font color="black">)</font>;
<font color="blue">#endif</font>

    <font color="green">// addition operators -- global friend functions.</font>

    <font color="blue">friend</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str1,  <font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str2<font color="black">)</font>;
    <font color="blue">friend</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str,   CT t<font color="black">)</font>;
    <font color="blue">friend</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str,   PCSTR sz<font color="black">)</font>;
    <font color="blue">friend</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str,   PCWSTR sz<font color="black">)</font>;
    <font color="blue">friend</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font>PCSTR pA,                 <font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str<font color="black">)</font>;
    <font color="blue">friend</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font>PCWSTR pW,                <font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str<font color="black">)</font>;
<font color="blue">#ifdef</font> SS_INC_COMDEF
    <font color="blue">friend</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font><font color="blue">const</font> _bstr_t<font color="black">&</font> bstr,      <font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str<font color="black">)</font>;
    <font color="blue">friend</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str,   <font color="blue">const</font> _bstr_t<font color="black">&</font> bstr<font color="black">)</font>;
<font color="blue">#endif</font>

    <font color="green">// Functions that make us almost as easy to use as MFC's CString</font>

<font color="blue">#ifndef</font> SS_ANSI
            <font color="blue">bool</font>            Load<font color="black">(</font>UINT nId<font color="black">)</font>;                         <font color="green">// load using resource id</font>
<font color="blue">#endif</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    Trim<font color="black">(</font><font color="black">)</font>;                                 <font color="green">// remove whitespace on both sides</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    ToUpper<font color="black">(</font><font color="black">)</font>;                              <font color="green">// make uppercase</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    ToLower<font color="black">(</font><font color="black">)</font>;                              <font color="green">// make lowercase</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    Normalize<font color="black">(</font><font color="black">)</font>;                            <font color="green">// same as Trim().ToLower()</font>
            CT<font color="black">*</font>             Buffer<font color="black">(</font><font color="blue">int</font> nMinLen<font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>;                 <font color="green">// like CString::GetBuffer()</font>
            CT<font color="black">*</font>             BufferSet<font color="black">(</font><font color="blue">int</font> nLen<font color="black">)</font>;                    <font color="green">// like CString::GetBufferSetLength</font>
            <font color="blue">void</font>            BufferRel<font color="black">(</font><font color="blue">int</font> nNewLen<font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>;              <font color="green">// like CString::ReleaseBuffer()</font>
            <font color="blue">bool</font>            Equals<font color="black">(</font><font color="blue">const</font> CT<font color="black">*</font> pT,                    <font color="green">// case INsensitive comparison</font>
                                   <font color="blue">bool</font> bUseCase<font color="black">=</font><font color="blue">false</font><font color="black">)</font> <font color="blue">const</font>;
                            <font color="blue">operator</font> <font color="blue">const</font> CT<font color="black">*</font><font color="black">(</font><font color="black">)</font> <font color="blue">const</font>;             <font color="green">// implicit cast to const TCHAR*</font>
            <font color="blue">void</font>            Format<font color="black">(</font><font color="blue">const</font> CT<font color="black">*</font> szFormat, ...<font color="black">)</font>;        <font color="green">// format using literal string</font>
<font color="blue">#ifndef</font> SS_ANSI
            <font color="blue">void</font>            Format<font color="black">(</font>UINT nId, ...<font color="black">)</font>;                  <font color="green">// format using resource string ID</font>
<font color="blue">#endif</font>
            <font color="blue">void</font>            FormatV<font color="black">(</font><font color="blue">const</font> CT<font color="black">*</font> szFormat,             <font color="green">// format with va_list instead of ...</font>
                                    va_list argList<font color="black">)</font>;   

    <font color="green">// CString facade functions -- make us a drop-in replacement for CString (almost).  </font>

<font color="blue">#ifndef</font> SS_ANSI
            BSTR            AllocSysString<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>;                 <font color="green">// whip up a BSTR from our data</font>
<font color="blue">#endif</font>
            <font color="blue">int</font>             Collate<font color="black">(</font>PCMYSTR szThat<font color="black">)</font> <font color="blue">const</font>;
            <font color="blue">int</font>             CollateNoCase<font color="black">(</font>PCMYSTR szThat<font color="black">)</font> <font color="blue">const</font>;
            <font color="blue">int</font>             CompareNoCase<font color="black">(</font>PCMYSTR szThat<font color="black">)</font> <font color="blue">const</font>;
            <font color="blue">int</font>             Delete<font color="black">(</font><font color="blue">int</font> nIdx, <font color="blue">int</font> nCount<font color="black">=</font><font color="maroon">1</font><font color="black">)</font>;
            <font color="blue">void</font>            Empty<font color="black">(</font><font color="black">)</font>;                                <font color="green">// erase  string and resize to 0</font>
            <font color="blue">int</font>             Find<font color="black">(</font>CT ch<font color="black">)</font> <font color="blue">const</font>;                      <font color="green">// find a character</font>
            <font color="blue">int</font>             Find<font color="black">(</font>PCMYSTR szSub<font color="black">)</font> <font color="blue">const</font>;              <font color="green">// find a substring</font>
            <font color="blue">int</font>             Find<font color="black">(</font>CT ch, <font color="blue">int</font> nStart<font color="black">)</font> <font color="blue">const</font>;          <font color="green">// find a character starting at nStart</font>
            <font color="blue">int</font>             Find<font color="black">(</font>PCMYSTR szSub, <font color="blue">int</font> nStart<font color="black">)</font><font color="blue">const</font>;   <font color="green">// Find a substring starting at nStart</font>
            <font color="blue">int</font>             FindOneOf<font color="black">(</font>PCMYSTR szCharSet<font color="black">)</font> <font color="blue">const</font>;     <font color="green">// Find one character from szCharSet</font>
<font color="blue">#ifndef</font> SS_ANSI
            <font color="blue">void</font>            FormatMessage<font color="black">(</font>PCMYSTR szFormat, ...<font color="black">)</font> <font color="blue">throw</font><font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>exception<font color="black">)</font>;
            <font color="blue">void</font>            FormatMessage<font color="black">(</font>UINT nFormatId, ...<font color="black">)</font> <font color="blue">throw</font><font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>exception<font color="black">)</font>;
<font color="blue">#endif</font>
            CT              GetAt<font color="black">(</font><font color="blue">int</font> nIdx<font color="black">)</font> <font color="blue">const</font>;                  <font color="green">// get character at nIdx</font>
            CT<font color="black">*</font>             GetBuffer<font color="black">(</font><font color="blue">int</font> nMinLen<font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>;              <font color="green">// naked buffer of lenght at least nLen</font>
            CT<font color="black">*</font>             GetBufferSetLength<font color="black">(</font><font color="blue">int</font> nLen<font color="black">)</font>;           <font color="green">// naked buffer of length nlen</font>
            <font color="blue">int</font>             GetLength<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>;                      <font color="green">// how many characters in the string?</font>
            <font color="blue">int</font>             Insert<font color="black">(</font><font color="blue">int</font> nIdx, CT ch<font color="black">)</font>;                <font color="green">// insert character ch at index nIdx</font>
            <font color="blue">int</font>             Insert<font color="black">(</font><font color="blue">int</font> nIdx, PCMYSTR sz<font color="black">)</font>;           <font color="green">// insert string sz at index nIdx</font>
            <font color="blue">bool</font>            IsEmpty<font color="black">(</font><font color="black">)</font> <font color="blue">const</font> <font color="black">{</font> <font color="blue">return</font> empty<font color="black">(</font><font color="black">)</font>; <font color="black">}</font>;    <font color="green">// is the string empty?</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font>     Left<font color="black">(</font><font color="blue">int</font> nCount<font color="black">)</font> <font color="blue">const</font>;                 <font color="green">// get the left nCount characters</font>
<font color="blue">#ifndef</font> SS_ANSI
            <font color="blue">bool</font>            LoadString<font color="black">(</font>UINT nId<font color="black">)</font>;                   <font color="green">// load from string resource</font>
<font color="blue">#endif</font>
            <font color="blue">void</font>            MakeLower<font color="black">(</font><font color="black">)</font>;                            <font color="green">// make lower case</font>
            <font color="blue">void</font>            MakeUpper<font color="black">(</font><font color="black">)</font>;                            <font color="green">// make upper case</font>
            <font color="blue">void</font>            MakeReverse<font color="black">(</font><font color="black">)</font>;                          <font color="green">// reverse the string</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font>     Mid<font color="black">(</font><font color="blue">int</font> nFirst<font color="black">)</font> <font color="blue">const</font>;                  <font color="green">// extract a substring </font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font>     Mid<font color="black">(</font><font color="blue">int</font> nFirst, <font color="blue">int</font> nCount<font color="black">)</font> <font color="blue">const</font>;      <font color="green">// extract a substring</font>
            <font color="blue">void</font>            ReleaseBuffer<font color="black">(</font><font color="blue">int</font> nNewLen<font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>;          <font color="green">// must call after GetBuffer</font>
            <font color="blue">int</font>             Remove<font color="black">(</font>CT ch<font color="black">)</font>;                          <font color="green">// remove all occurrences of ch</font>
            <font color="blue">int</font>             Replace<font color="black">(</font>TCHAR chOld, TCHAR chNew<font color="black">)</font>;      <font color="green">// replace all chOld with chNew</font>
            <font color="blue">int</font>             Replace<font color="black">(</font>PCMYSTR szOld, PCMYSTR szNew<font color="black">)</font>;  <font color="green">// replace all szOld with chNew</font>
            <font color="blue">int</font>             ReverseFind<font color="black">(</font>CT ch<font color="black">)</font>;                     <font color="green">// find starting from the back</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font>     Right<font color="black">(</font><font color="blue">int</font> nCount<font color="black">)</font> <font color="blue">const</font>;                <font color="green">// get the rightmost nCount characters</font>
            <font color="blue">void</font>            SetAt<font color="black">(</font><font color="blue">int</font> nIndex, CT ch<font color="black">)</font>;               <font color="green">// set a character at zero-based index</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font>     SpanExcluding<font color="black">(</font>PCMYSTR szCharSet<font color="black">)</font> <font color="blue">const</font>; <font color="green">// extract start to any in szCharSet</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font>     SpanIncluding<font color="black">(</font>PCMYSTR szCharSet<font color="black">)</font> <font color="blue">const</font>; <font color="green">// extract start to any NOT in szCharSet</font>
<font color="blue">#ifndef</font> SS_ANSI
            BSTR            SetSysString<font color="black">(</font>BSTR<font color="black">*</font> pbstr<font color="black">)</font> <font color="blue">const</font>;        <font color="green">// reset a BSTR with our data</font>
<font color="blue">#endif</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    TrimLeft<font color="black">(</font><font color="black">)</font>;                             <font color="green">// remove whitespace on left</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    TrimLeft<font color="black">(</font>CT tTrim<font color="black">)</font>;                     <font color="green">// remove 'tTrim' charss on left</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    TrimLeft<font color="black">(</font>PCMYSTR szTrimChars<font color="black">)</font>;          <font color="green">// remove chars in 'szTrimChars' on left</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    TrimRight<font color="black">(</font><font color="black">)</font>;                            <font color="green">// remove whitespace characters on right</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    TrimRight<font color="black">(</font>CT tTrim<font color="black">)</font>;                    <font color="green">// remove 'tTrim' characters on right</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>    TrimRight<font color="black">(</font>PCMYSTR szTrimChars<font color="black">)</font>;         <font color="green">// remove chars in 'szTrimChars' on right</font>
<font color="blue">#if</font> <font color="black">!</font>defined<font color="black">(</font>UNICODE<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font>defined<font color="black">(</font>SS_ANSI<font color="black">)</font>
            <font color="blue">void</font>            AnsiToOem<font color="black">(</font><font color="black">)</font>;                            <font color="green">// does anybody EVER call this?</font>
            <font color="blue">void</font>            OemToAnsi<font color="black">(</font><font color="black">)</font>;                            <font color="green">// does anybody EVER call this?</font>
<font color="blue">#endif</font>

            <font color="green">// I have intentionally not implemented the following CString</font>
            <font color="green">// functions.   You cannot make them work without taking advantage</font>
            <font color="green">// of implementation specific behavior.  However if you absolutely</font>
            <font color="green">// MUST have them, uncomment out these lines for "sort-of-like"</font>
            <font color="green">// their behavior.  You're on your own.</font>

<font color="green">//          CT*             LockBuffer()    { return Buffer(); }    // won't really lock the string</font>
<font color="green">//          void            UnlockBuffer(); { }                     // why have UnlockBuffer w/o LockBuffer?</font>
<font color="green">//          void            FreeExtra();    { resize(0); }          // not guaranteed to free anything</font>

    <font color="green">// Array-indexing operators.  Required because we defined an implicit cast to operator const CT*</font>
    <font color="green">// (Thanks to Julian Selman for pointing this out)</font>

            CT<font color="black">&</font>             <font color="blue">operator</font><font color="black">[</font><font color="black">]</font><font color="black">(</font><font color="blue">int</font> nIdx<font color="black">)</font>;
            <font color="blue">const</font> CT<font color="black">&</font>       <font color="blue">operator</font><font color="black">[</font><font color="black">]</font><font color="black">(</font><font color="blue">int</font> nIdx<font color="black">)</font> <font color="blue">const</font>; 
            CT<font color="black">&</font>             <font color="blue">operator</font><font color="black">[</font><font color="black">]</font><font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> nIdx<font color="black">)</font>;
            <font color="blue">const</font> CT<font color="black">&</font>       <font color="blue">operator</font><font color="black">[</font><font color="black">]</font><font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> nIdx<font color="black">)</font> <font color="blue">const</font>;    

    <font color="green">// IStream related functions.  Useful in IPersistStream implementations</font>
<font color="blue">#ifdef</font> SS_INC_COMDEF
            HRESULT         StreamSave<font color="black">(</font>IStream<font color="black">*</font> pStream<font color="black">)</font> <font color="blue">const</font>;     <font color="green">// write to an IStream</font>
            HRESULT         StreamLoad<font color="black">(</font>IStream<font color="black">*</font> pStream<font color="black">)</font>;           <font color="green">// read from an IStream;</font>
            ULONG           StreamSize<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>;                     <font color="green">// # of bytes needed to StreamSave()</font>
<font color="blue">#endif</font>
<font color="green">//  static  bool            Wildstrcmp (PCTSTR c_s, PCTSTR c_mask);</font>

    <font color="green">// SetResourceHandle/GetResourceHandle.  In MFC builds, these map directly</font>
    <font color="green">// to AfxSetResourceHandle and AfxGetResourceHandle.  In non-MFC builds they</font>
    <font color="green">// point to a single static HINST so that those who call the member</font>
    <font color="green">// functions that take resource IDs can provide an alternate HINST of a DLL</font>
    <font color="green">// to search.  This is not exactly the list of HMODULES that MFC provides</font>
    <font color="green">// but it's better than nothing.</font>

    <font color="blue">static</font>  <font color="blue">void</font>            SetResourceHandle<font color="black">(</font>HMODULE hNew<font color="black">)</font>;
    <font color="blue">static</font>  HMODULE         GetResourceHandle<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>;

<font color="green">// shorthand conversion from PCTSTR to string resource ID</font>
<font color="blue">#define</font> _TRES<font color="black">(</font>pctstr<font color="black">)</font> <font color="black">(</font>LOWORD<font color="black">(</font><font color="black">(</font>DWORD<font color="black">)</font><font color="black">(</font>pctstr<font color="black">)</font><font color="black">)</font><font color="black">)</font> 

<font color="green">// CStdStr inline constructors</font>
<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>CStdStr<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>CStdStr<font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str<font color="black">)</font> <font color="black">:</font> MYBASE<font color="black">(</font>SSREF<font color="black">(</font>str<font color="black">)</font><font color="black">)</font>
<font color="black">{</font>
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>CStdStr<font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> str<font color="black">)</font>
<font color="black">{</font>
    ssasn<font color="black">(</font><font color="black">*</font><font color="blue">this</font>, SSREF<font color="black">(</font>str<font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>CStdStr<font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> str<font color="black">)</font>
<font color="black">{</font>
    ssasn<font color="black">(</font><font color="black">*</font><font color="blue">this</font>, SSREF<font color="black">(</font>str<font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>CStdStr<font color="black">(</font>PCMYSTR pT, MYSIZE n<font color="black">)</font> <font color="black">:</font> MYBASE<font color="black">(</font>pT, n<font color="black">)</font>
<font color="black">{</font>
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>CStdStr<font color="black">(</font>PCSTR pA<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> NULL <font color="black">!</font><font color="black">=</font> HIWORD<font color="black">(</font>pA<font color="black">)</font> <font color="black">)</font>
        <font color="black">*</font><font color="blue">this</font> <font color="black">=</font> pA;
<font color="blue">#ifdef</font> SS_ANSI
<font color="blue">#else</font>
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> NULL <font color="black">!</font><font color="black">=</font> pA <font color="black">&</font><font color="black">&</font> <font color="black">!</font>Load<font color="black">(</font>_TRES<font color="black">(</font>pA<font color="black">)</font><font color="black">)</font> <font color="black">)</font>
        TRACE<font color="black">(</font>_T<font color="black">(</font><font color="maroon">"Can't load string %u\n"</font><font color="black">)</font>, _TRES<font color="black">(</font>pA<font color="black">)</font><font color="black">)</font>;
<font color="blue">#endif</font>
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>CStdStr<font color="black">(</font>PCWSTR pW<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> NULL <font color="black">!</font><font color="black">=</font> HIWORD<font color="black">(</font>pW<font color="black">)</font> <font color="black">)</font>
        <font color="black">*</font><font color="blue">this</font> <font color="black">=</font> pW;
<font color="blue">#ifdef</font> SS_ANSI
<font color="blue">#else</font>
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> NULL <font color="black">!</font><font color="black">=</font> pW <font color="black">&</font><font color="black">&</font> <font color="black">!</font>Load<font color="black">(</font>_TRES<font color="black">(</font>pW<font color="black">)</font><font color="black">)</font> <font color="black">)</font>
        TRACE<font color="black">(</font>_T<font color="black">(</font><font color="maroon">"Can't load string %u\n"</font><font color="black">)</font>, _TRES<font color="black">(</font>pW<font color="black">)</font><font color="black">)</font>;
<font color="blue">#endif</font>
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>CStdStr<font color="black">(</font>MYCITER first, MYCITER last<font color="black">)</font>
    <font color="black">:</font> MYBASE<font color="black">(</font>first, last<font color="black">)</font>
<font color="black">{</font>
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>CStdStr<font color="black">(</font>MYSIZE nSize, MYVAL ch, <font color="blue">const</font> MYALLOC<font color="black">&</font> al<font color="black">)</font>
    <font color="black">:</font> MYBASE<font color="black">(</font>nSize, ch, al<font color="black">)</font>
<font color="black">{</font>
<font color="black">}</font>

<font color="blue">#ifdef</font> SS_INC_COMDEF
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>CStdStr<font color="black">(</font><font color="blue">const</font> _bstr_t<font color="black">&</font> bstr<font color="black">)</font>
    <font color="black">{</font>
        <font color="black">*</font><font color="blue">this</font> <font color="black">=</font> static_cast<font color="black">&#60;</font>PCTSTR<font color="black">&#62;</font><font color="black">(</font>bstr<font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#endif</font>


<font color="green">// CStdStr inline assignment operators -- the ssasn function now takes care</font>
<font color="green">// of fixing  the MSVC assignment bug (see knowledge base article Q172398).</font>
<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str<font color="black">)</font>
<font color="black">{</font> 
    ssasn<font color="black">(</font><font color="black">*</font><font color="blue">this</font>, str<font color="black">)</font>; 
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> str<font color="black">)</font>
<font color="black">{</font>
    ssasn<font color="black">(</font><font color="black">*</font><font color="blue">this</font>, str<font color="black">)</font>;
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font> 
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> str<font color="black">)</font>
<font color="black">{</font>
    ssasn<font color="black">(</font><font color="black">*</font><font color="blue">this</font>, str<font color="black">)</font>;
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">=</font><font color="black">(</font>PCSTR pA<font color="black">)</font>
<font color="black">{</font>
    ssasn<font color="black">(</font><font color="black">*</font><font color="blue">this</font>, pA<font color="black">)</font>;
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">=</font><font color="black">(</font>PCWSTR pW<font color="black">)</font>
<font color="black">{</font>
    ssasn<font color="black">(</font><font color="black">*</font><font color="blue">this</font>, pW<font color="black">)</font>;
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">=</font><font color="black">(</font>CT t<font color="black">)</font>
<font color="black">{</font>
    Q172398<font color="black">(</font><font color="black">*</font><font color="blue">this</font><font color="black">)</font>;
    MYBASE<font color="black">:</font><font color="black">:</font>assign<font color="black">(</font><font color="maroon">1</font>, t<font color="black">)</font>;
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">#ifdef</font> SS_INC_COMDEF
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font>
    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> _bstr_t<font color="black">&</font> bstr<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> <font color="blue">operator</font><font color="black">=</font><font color="black">(</font>static_cast<font color="black">&#60;</font><font color="blue">const</font> CT<font color="black">*</font><font color="black">&#62;</font><font color="black">(</font>bstr<font color="black">)</font><font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#endif</font>



<font color="green">// These overloads are also needed to fix the MSVC assignment bug (KB: Q172398)</font>
<font color="green">//  *** Thanks to Pete The Plumber for catching this one ***</font>
<font color="green">// They also are compiled if you have explicitly turned off refcounting</font>
<font color="blue">#if</font> <font color="black">(</font> defined<font color="black">(</font>_MSC_VER<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font> _MSC_VER <font color="black">&#60;</font> <font color="maroon">1200</font> <font color="black">)</font> <font color="black">)</font> <font color="black">|</font><font color="black">|</font> defined<font color="black">(</font>SS_NO_REFCOUNT<font color="black">)</font> 

    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font>
    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>assign<font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str<font color="black">)</font>
    <font color="black">{</font>
        ssasn<font color="black">(</font><font color="black">*</font><font color="blue">this</font>, str<font color="black">)</font>;
        <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
    <font color="black">}</font>

    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font>
    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>assign<font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str,
                                     MYSIZE nStart, MYSIZE nChars<font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// This overload of basic_string::assign is supposed to assign up to</font>
        <font color="green">// &#60;nChars&#62; or the NULL terminator, whichever comes first.  Since we</font>
        <font color="green">// are about to call a less forgiving overload (in which &#60;nChars&#62; must</font>
        <font color="green">// be a valid length), we must adjust the length here to a safe value.</font>
        <font color="green">// Thanks to Ullrich Pollähne for catching this bug</font>

        nChars      <font color="black">=</font> SSMIN<font color="black">(</font>nChars, str.length<font color="black">(</font><font color="black">)</font> <font color="black">-</font>nStart<font color="black">)</font>;

        <font color="green">// Watch out for assignment to self</font>

        <font color="blue">if</font> <font color="black">(</font> <font color="blue">this</font> <font color="black">=</font><font color="black">=</font> <font color="black">&</font>str <font color="black">)</font>
        <font color="black">{</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> strTemp<font color="black">(</font>str.c_str<font color="black">(</font><font color="black">)</font><font color="black">+</font>nStart, nChars<font color="black">)</font>;
            assign<font color="black">(</font>strTemp<font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            Q172398<font color="black">(</font><font color="black">*</font><font color="blue">this</font><font color="black">)</font>;
            MYBASE<font color="black">:</font><font color="black">:</font>assign<font color="black">(</font>str.c_str<font color="black">(</font><font color="black">)</font><font color="black">+</font>nStart, nChars<font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
    <font color="black">}</font>

    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font>
    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>assign<font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>basic_string<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str<font color="black">)</font>
    <font color="black">{</font>
        ssasn<font color="black">(</font><font color="black">*</font><font color="blue">this</font>, str<font color="black">)</font>;
        <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
    <font color="black">}</font>

    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font>
    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>assign<font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>basic_string<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str,
                                     MYSIZE nStart, MYSIZE nChars<font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// This overload of basic_string::assign is supposed to assign up to</font>
        <font color="green">// &#60;nChars&#62; or the NULL terminator, whichever comes first.  Since we</font>
        <font color="green">// are about to call a less forgiving overload (in which &#60;nChars&#62; must</font>
        <font color="green">// be a valid length), we must adjust the length here to a safe value.</font>
        <font color="green">// Thanks to Ullrich Pollähne for catching this bug</font>

        nChars      <font color="black">=</font> SSMIN<font color="black">(</font>nChars, str.length<font color="black">(</font><font color="black">)</font> <font color="black">-</font>nStart<font color="black">)</font>;

        <font color="green">// Watch out for assignment to self</font>

        <font color="blue">if</font> <font color="black">(</font> <font color="blue">this</font> <font color="black">=</font><font color="black">=</font> <font color="black">&</font>str <font color="black">)</font> <font color="green">// watch out for assignment to self</font>
        <font color="black">{</font>
            CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> strTemp<font color="black">(</font>str.c_str<font color="black">(</font><font color="black">)</font> <font color="black">+</font> nStart, nChars<font color="black">)</font>;
            assign<font color="black">(</font>strTemp<font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            Q172398<font color="black">(</font><font color="black">*</font><font color="blue">this</font><font color="black">)</font>;
            MYBASE<font color="black">:</font><font color="black">:</font>assign<font color="black">(</font>str.c_str<font color="black">(</font><font color="black">)</font><font color="black">+</font>nStart, nChars<font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
    <font color="black">}</font>

    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font>
    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>assign<font color="black">(</font><font color="blue">const</font> CT<font color="black">*</font> pC, MYSIZE nChars<font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Q172398 only fix -- erase before assigning, but not if we're assigning</font>
        <font color="green">// from our own buffer</font>

<font color="blue">#if</font> defined <font color="black">(</font> _MSC_VER <font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font> _MSC_VER <font color="black">&#60;</font> <font color="maroon">1200</font> <font color="black">)</font>
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font>empty<font color="black">(</font><font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font> pC <font color="black">&#60;</font> data<font color="black">(</font><font color="black">)</font> <font color="black">|</font><font color="black">|</font> pC <font color="black">&#62;</font> data<font color="black">(</font><font color="black">)</font> <font color="black">+</font> capacity<font color="black">(</font><font color="black">)</font> <font color="black">)</font> <font color="black">)</font>
            erase<font color="black">(</font><font color="black">)</font>;
<font color="blue">#endif</font>
        Q172398<font color="black">(</font><font color="black">*</font><font color="blue">this</font><font color="black">)</font>;
        MYBASE<font color="black">:</font><font color="black">:</font>assign<font color="black">(</font>pC, nChars<font color="black">)</font>;
        <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
    <font color="black">}</font>

    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font>
    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>assign<font color="black">(</font>MYSIZE nChars, MYVAL val<font color="black">)</font>
    <font color="black">{</font>
        Q172398<font color="black">(</font><font color="black">*</font><font color="blue">this</font><font color="black">)</font>;
        MYBASE<font color="black">:</font><font color="black">:</font>assign<font color="black">(</font>nChars, val<font color="black">)</font>;
        <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
    <font color="black">}</font>

    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font>
    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>assign<font color="black">(</font><font color="blue">const</font> CT<font color="black">*</font> pT<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> assign<font color="black">(</font>pT, CStdStr<font color="black">:</font><font color="black">:</font>traits_type<font color="black">:</font><font color="black">:</font>length<font color="black">(</font>pT<font color="black">)</font><font color="black">)</font>;
    <font color="black">}</font>

    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font>
    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>assign<font color="black">(</font>MYCITER iterFirst,
                                     MYCITER iterLast<font color="black">)</font>
    <font color="black">{</font>
<font color="blue">#if</font> defined <font color="black">(</font> _MSC_VER <font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font> _MSC_VER <font color="black">&#60;</font> <font color="maroon">1200</font> <font color="black">)</font> 
        <font color="green">// Q172398 fix.  don't call erase() if we're assigning from ourself</font>
        <font color="blue">if</font> <font color="black">(</font> iterFirst <font color="black">&#60;</font> begin<font color="black">(</font><font color="black">)</font> <font color="black">|</font><font color="black">|</font> iterFirst <font color="black">&#62;</font> begin<font color="black">(</font><font color="black">)</font> <font color="black">+</font> size<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
            erase<font color="black">(</font><font color="black">)</font>
<font color="blue">#endif</font>
        replace<font color="black">(</font>begin<font color="black">(</font><font color="black">)</font>, end<font color="black">(</font><font color="black">)</font>, iterFirst, iterLast<font color="black">)</font>;
        <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
    <font color="black">}</font>
<font color="blue">#endif</font>

    
<font color="green">// CStdStr inline comparison (equality), defaults to case insensitive</font>


<font color="green">// CStdStr inline comparison (equality), defaults to case insensitive</font>
<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">bool</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Equals<font color="black">(</font><font color="blue">const</font> CT<font color="black">*</font> pT, <font color="blue">bool</font> bUseCase<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>   <font color="green">// get copy, THEN compare (thread safe)</font>
    <font color="blue">return</font>  bUseCase ? compare<font color="black">(</font>pT<font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">:</font> ssicmp<font color="black">(</font>CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">(</font><font color="black">*</font><font color="blue">this</font><font color="black">)</font>, pT<font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font>;
<font color="black">}</font> 

<font color="green">// CStdStr inline concatenation.</font>
<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">+</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> MYTYPE<font color="black">&</font> str<font color="black">)</font>
<font color="black">{</font>
    ssadd<font color="black">(</font><font color="black">*</font><font color="blue">this</font>, str<font color="black">)</font>;
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">+</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>string<font color="black">&</font> str<font color="black">)</font>
<font color="black">{</font>
    ssadd<font color="black">(</font><font color="black">*</font><font color="blue">this</font>, str<font color="black">)</font>;
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>; 
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">+</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> NSP<font color="black">:</font><font color="black">:</font>wstring<font color="black">&</font> str<font color="black">)</font>
<font color="black">{</font>
    ssadd<font color="black">(</font><font color="black">*</font><font color="blue">this</font>, str<font color="black">)</font>;
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">+</font><font color="black">=</font><font color="black">(</font>PCSTR pA<font color="black">)</font>
<font color="black">{</font>
    ssadd<font color="black">(</font><font color="black">*</font><font color="blue">this</font>, pA<font color="black">)</font>;
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">+</font><font color="black">=</font><font color="black">(</font>PCWSTR pW<font color="black">)</font>
<font color="black">{</font>
    ssadd<font color="black">(</font><font color="black">*</font><font color="blue">this</font>, pW<font color="black">)</font>;
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">+</font><font color="black">=</font><font color="black">(</font>CT t<font color="black">)</font>
<font color="black">{</font>
    append<font color="black">(</font><font color="maroon">1</font>, t<font color="black">)</font>;
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>
<font color="blue">#ifdef</font> SS_INC_COMDEF    <font color="green">// if we have _bstr_t, define a += for it too.</font>
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font>
    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">+</font><font color="black">=</font><font color="black">(</font><font color="blue">const</font> _bstr_t<font color="black">&</font> bstr<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> <font color="blue">operator</font><font color="black">+</font><font color="black">=</font><font color="black">(</font>static_cast<font color="black">&#60;</font>PCMYSTR<font color="black">&#62;</font><font color="black">(</font>bstr<font color="black">)</font><font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#endif</font>

<font color="green">// CStdStr friend addition functions defined as inline</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font><font color="blue">const</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str1, <font color="blue">const</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str2<font color="black">)</font>
<font color="black">{</font>
    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> strRet<font color="black">(</font>SSREF<font color="black">(</font>str1<font color="black">)</font><font color="black">)</font>;
    strRet.append<font color="black">(</font>str2<font color="black">)</font>;
    <font color="blue">return</font> strRet;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>   
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font><font color="blue">const</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str, CT t<font color="black">)</font>
<font color="black">{</font>
    <font color="green">// this particular overload is needed for disabling reference counting</font>
    <font color="green">// though it's only an issue from line 1 to line 2</font>

    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> strRet<font color="black">(</font>SSREF<font color="black">(</font>str<font color="black">)</font><font color="black">)</font>; <font color="green">// 1</font>
    strRet.append<font color="black">(</font><font color="maroon">1</font>, t<font color="black">)</font>;                <font color="green">// 2</font>
    <font color="blue">return</font> strRet;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font><font color="blue">const</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str, PCSTR pA<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">(</font>str<font color="black">)</font> <font color="black">+</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">(</font>pA<font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font>PCSTR pA, <font color="blue">const</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str<font color="black">)</font>
<font color="black">{</font>
    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> strRet<font color="black">(</font>pA<font color="black">)</font>;
    strRet.append<font color="black">(</font>str<font color="black">)</font>;
    <font color="blue">return</font> strRet;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str, PCWSTR pW<font color="black">)</font>
<font color="black">{</font> 
    <font color="blue">return</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">(</font>SSREF<font color="black">(</font>str<font color="black">)</font><font color="black">)</font> <font color="black">+</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">(</font>pW<font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font>PCWSTR pW, <font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str<font color="black">)</font>
<font color="black">{</font>
    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> strRet<font color="black">(</font>pW<font color="black">)</font>;
    strRet.append<font color="black">(</font>str<font color="black">)</font>;
    <font color="blue">return</font> strRet;
<font color="black">}</font>

<font color="blue">#ifdef</font> SS_INC_COMDEF
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font>
    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font><font color="blue">const</font> _bstr_t<font color="black">&</font> bstr, <font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> static_cast<font color="black">&#60;</font><font color="blue">const</font> CT<font color="black">*</font><font color="black">&#62;</font><font color="black">(</font>bstr<font color="black">)</font> <font color="black">+</font> str;
    <font color="black">}</font>

    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font>
    CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> <font color="blue">operator</font><font color="black">+</font><font color="black">(</font><font color="blue">const</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> str, <font color="blue">const</font> _bstr_t<font color="black">&</font> bstr<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> str <font color="black">+</font> static_cast<font color="black">&#60;</font><font color="blue">const</font> CT<font color="black">*</font><font color="black">&#62;</font><font color="black">(</font>bstr<font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#endif</font>

<font color="green">// CStdStr array indexing</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CT<font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">[</font><font color="black">]</font><font color="black">(</font><font color="blue">int</font> nIdx<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> MYBASE<font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">[</font><font color="black">]</font><font color="black">(</font>static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nIdx<font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">const</font> CT<font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">[</font><font color="black">]</font><font color="black">(</font><font color="blue">int</font> nIdx<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> MYBASE<font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">[</font><font color="black">]</font><font color="black">(</font>static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nIdx<font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CT<font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">[</font><font color="black">]</font><font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> nIdx<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> MYBASE<font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">[</font><font color="black">]</font><font color="black">(</font>static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nIdx<font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">const</font> CT<font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">[</font><font color="black">]</font><font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> nIdx<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> MYBASE<font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">[</font><font color="black">]</font><font color="black">(</font>static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nIdx<font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font><font color="blue">operator</font> <font color="blue">const</font> CT<font color="black">*</font><font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> c_str<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>

<font color="green">// CStdStr -- Direct access to character buffer.  In the MS' implementation, the</font>
<font color="green">// at() function that we use here also calls _Freeze() providing us some measure</font>
<font color="green">// of protection from multithreading problems associated with reference counting.</font>
<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font> 
CT<font color="black">*</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Buffer<font color="black">(</font><font color="blue">int</font> nMinLen<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> nMinLen <font color="black">&#62;</font> <font color="maroon">-1</font> <font color="black">)</font>
        resize<font color="black">(</font>static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nMinLen<font color="black">)</font><font color="black">)</font>;

    <font color="blue">return</font> empty<font color="black">(</font><font color="black">)</font> ? const_cast<font color="black">&#60;</font>CT<font color="black">*</font><font color="black">&#62;</font><font color="black">(</font>data<font color="black">(</font><font color="black">)</font><font color="black">)</font> <font color="black">:</font> <font color="black">&</font><font color="black">(</font>at<font color="black">(</font><font color="maroon">0</font><font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CT<font color="black">*</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>BufferSet<font color="black">(</font><font color="blue">int</font> nLen<font color="black">)</font>
<font color="black">{</font>
    nLen <font color="black">=</font> <font color="black">(</font> nLen <font color="black">&#62;</font> <font color="maroon">0</font> ? nLen <font color="black">:</font> <font color="maroon">0</font> <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> capacity<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font> <font color="maroon">1</font> <font color="black">&</font><font color="black">&</font> nLen <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
        resize<font color="black">(</font><font color="maroon">1</font><font color="black">)</font>;

    resize<font color="black">(</font>static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nLen<font color="black">)</font><font color="black">)</font>;
    <font color="blue">return</font> const_cast<font color="black">&#60;</font>CT<font color="black">*</font><font color="black">&#62;</font><font color="black">(</font>data<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>BufferRel<font color="black">(</font><font color="blue">int</font> nNewLen<font color="black">)</font>
<font color="black">{</font>
    resize<font color="black">(</font>static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nNewLen <font color="black">&#62;</font> <font color="maroon">-1</font> ? nNewLen <font color="black">:</font> sslen<font color="black">(</font>c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>


<font color="green">// This struct is used for TrimRight() and TrimLeft() function implementations.</font>
<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">struct</font> NotSpace <font color="black">:</font> <font color="blue">public</font> NSP<font color="black">:</font><font color="black">:</font>unary_function<font color="black">&#60;</font>CT, <font color="blue">bool</font><font color="black">&#62;</font>
<font color="black">{</font>
    <font color="blue">inline</font> <font color="blue">bool</font> <font color="blue">operator</font><font color="black">(</font><font color="black">)</font> <font color="black">(</font>CT tchar<font color="black">)</font> <font color="black">{</font> <font color="blue">return</font> <font color="black">!</font>ssisp<font color="black">(</font>tchar<font color="black">)</font>; <font color="black">}</font>
<font color="black">}</font>;


<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Trim<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> TrimLeft<font color="black">(</font><font color="black">)</font>.TrimRight<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>TrimLeft<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    MYITER it <font color="black">=</font> NSP<font color="black">:</font><font color="black">:</font>find_if<font color="black">(</font>begin<font color="black">(</font><font color="black">)</font>, end<font color="black">(</font><font color="black">)</font>, NotSpace<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> end<font color="black">(</font><font color="black">)</font> <font color="black">!</font><font color="black">=</font> it <font color="black">)</font> <font color="green">// avoid  assignment when possible</font>
    <font color="black">{</font>
        traits_type<font color="black">(</font><font color="black">)</font>.move<font color="black">(</font><font color="black">&</font><font color="black">(</font><font color="black">*</font>begin<font color="black">(</font><font color="black">)</font><font color="black">)</font>, <font color="black">&</font><font color="black">(</font><font color="black">*</font>it<font color="black">)</font>, <font color="black">(</font>end<font color="black">(</font><font color="black">)</font> <font color="black">-</font>it<font color="black">+</font><font color="maroon">1</font><font color="black">)</font> <font color="black">*</font> <font color="blue">sizeof</font><font color="black">(</font>CT<font color="black">)</font><font color="black">)</font>;
        resize<font color="black">(</font>end<font color="black">(</font><font color="black">)</font> <font color="black">-</font>it<font color="black">)</font>;
    <font color="black">}</font>

    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>TrimLeft<font color="black">(</font>CT tTrim<font color="black">)</font>
<font color="black">{</font>
    erase<font color="black">(</font><font color="maroon">0</font>, find_first_not_of<font color="black">(</font>tTrim<font color="black">)</font><font color="black">)</font>;
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>TrimLeft<font color="black">(</font>PCMYSTR szTrimChars<font color="black">)</font>
<font color="black">{</font>
    erase<font color="black">(</font><font color="maroon">0</font>, find_first_not_of<font color="black">(</font>szTrimChars<font color="black">)</font><font color="black">)</font>;
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>TrimRight<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    reverse_iterator it <font color="black">=</font> NSP<font color="black">:</font><font color="black">:</font>find_if<font color="black">(</font>rbegin<font color="black">(</font><font color="black">)</font>, rend<font color="black">(</font><font color="black">)</font>, NotSpace<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> rend<font color="black">(</font><font color="black">)</font> <font color="black">!</font><font color="black">=</font> it <font color="black">)</font>
        erase<font color="black">(</font>rend<font color="black">(</font><font color="black">)</font> <font color="black">-</font>it<font color="black">)</font>;

    erase<font color="black">(</font>it <font color="black">!</font><font color="black">=</font> rend<font color="black">(</font><font color="black">)</font> ? find_last_of<font color="black">(</font><font color="black">*</font>it<font color="black">)</font> <font color="black">+</font> <font color="maroon">1</font> <font color="black">:</font> <font color="maroon">0</font><font color="black">)</font>;
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>TrimRight<font color="black">(</font>CT tTrim<font color="black">)</font>
<font color="black">{</font>
    MYSIZE nIdx <font color="black">=</font> find_last_not_of<font color="black">(</font>tTrim<font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> npos <font color="black">=</font><font color="black">=</font> nIdx <font color="black">)</font>
    <font color="black">{</font>
        erase<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">else</font>
    <font color="black">{</font>
        <font color="green">// TODO: there's got to be a better, standard way to do this that</font>
        <font color="green">// avoids calling length() (since  SGI's length() is slow)</font>

        CT tSave    <font color="black">=</font> at<font color="black">(</font>nIdx<font color="black">)</font>;
        erase<font color="black">(</font>nIdx, npos<font color="black">)</font>;  
        append<font color="black">(</font><font color="maroon">1</font>, tSave<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font>  CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>TrimRight<font color="black">(</font>PCMYSTR szTrimChars<font color="black">)</font>
<font color="black">{</font>
    MYSIZE nIdx <font color="black">=</font> find_last_not_of<font color="black">(</font>szTrimChars<font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> npos <font color="black">=</font><font color="black">=</font> nIdx <font color="black">)</font>
    <font color="black">{</font>
        erase<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">else</font>
    <font color="black">{</font>
        <font color="green">// TODO: there's got to be a better, standard way to do this that</font>
        <font color="green">// avoids calling length() (since  SGI's length() is slow)</font>

        CT tSave    <font color="black">=</font> at<font color="black">(</font>nIdx<font color="black">)</font>;
        erase<font color="black">(</font>nIdx, npos<font color="black">)</font>;  
        append<font color="black">(</font><font color="maroon">1</font>, tSave<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>ToUpper<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font>empty<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
        ssupr<font color="black">(</font>Buffer<font color="black">(</font><font color="black">)</font>, size<font color="black">(</font><font color="black">)</font><font color="black">)</font>;

    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>ToLower<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font>empty<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
        sslwr<font color="black">(</font>Buffer<font color="black">(</font><font color="black">)</font>, size<font color="black">(</font><font color="black">)</font><font color="black">)</font>;

    <font color="blue">return</font> <font color="black">*</font><font color="blue">this</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">&</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Normalize<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> Trim<font color="black">(</font><font color="black">)</font>.ToLower<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>



<font color="blue">#ifndef</font> SS_ANSI
<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">bool</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Load<font color="black">(</font>UINT nId<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">bool</font> bLoaded        <font color="black">=</font> <font color="blue">false</font>;    <font color="green">// set to true of we succeed.</font>

<font color="blue">#ifdef</font> _MFC_VER     <font color="green">// When in Rome...</font>

    CString strRes;
    bLoaded             <font color="black">=</font> FALSE <font color="black">!</font><font color="black">=</font> strRes.LoadString<font color="black">(</font>nId<font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> bLoaded <font color="black">)</font>
        <font color="black">*</font><font color="blue">this</font>           <font color="black">=</font> strRes;

<font color="blue">#else</font>
    
    <font color="green">// Get the resource name and module handle</font>

    PCTSTR szName       <font color="black">=</font> MAKEINTRESOURCE<font color="black">(</font><font color="black">(</font>nId<font color="black">&#62;</font><font color="black">&#62;</font><font color="maroon">4</font><font color="black">)</font><font color="black">+</font><font color="maroon">1</font><font color="black">)</font>; <font color="green">// lifted from CString</font>
    HMODULE hModule     <font color="black">=</font> GetResourceHandle<font color="black">(</font><font color="black">)</font>;
    DWORD dwSize        <font color="black">=</font> <font color="maroon">0</font>;

    <font color="green">// No sense continuing if we can't find the resource</font>

    HRSRC hrsrc         <font color="black">=</font> <font color="black">:</font><font color="black">:</font>FindResource<font color="black">(</font>hModule, szName, RT_STRING<font color="black">)</font>;

    <font color="blue">if</font> <font color="black">(</font> NULL <font color="black">=</font><font color="black">=</font> hrsrc <font color="black">)</font>
        TRACE<font color="black">(</font>_T<font color="black">(</font><font color="maroon">"Cannot find resource %d: 0x%X"</font><font color="black">)</font>, nId, <font color="black">:</font><font color="black">:</font>GetLastError<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> <font color="maroon">0</font> <font color="black">=</font><font color="black">=</font> <font color="black">(</font>dwSize <font color="black">=</font> <font color="black">:</font><font color="black">:</font>SizeofResource<font color="black">(</font>hModule, hrsrc<font color="black">)</font> <font color="black">/</font> <font color="blue">sizeof</font><font color="black">(</font>CT<font color="black">)</font><font color="black">)</font> <font color="black">)</font>
        TRACE<font color="black">(</font>_T<font color="black">(</font><font color="maroon">"Cannot get size of resource %d: 0x%X\n"</font><font color="black">)</font>, nId, GetLastError<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">else</font>
    <font color="black">{</font>
        bLoaded         <font color="black">=</font> <font color="black">(</font> <font color="maroon">0</font> <font color="black">!</font><font color="black">=</font> ssload<font color="black">(</font>hModule, nId, Buffer<font color="black">(</font>dwSize<font color="black">)</font>, dwSize<font color="black">)</font> <font color="black">)</font>;
        ReleaseBuffer<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font>

<font color="blue">#endif</font>

    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font>bLoaded <font color="black">)</font>
        TRACE<font color="black">(</font>_T<font color="black">(</font><font color="maroon">"String not loaded 0x%X\n"</font><font color="black">)</font>, <font color="black">:</font><font color="black">:</font>GetLastError<font color="black">(</font><font color="black">)</font><font color="black">)</font>;

    <font color="blue">return</font> bLoaded;
<font color="black">}</font>
<font color="blue">#endif</font>

<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// FUNCTION:  CStdStr::Format</font>
<font color="green">//      void _cdecl Formst(CStdStringA& PCSTR szFormat, ...)</font>
<font color="green">//      void _cdecl Format(PCSTR szFormat);</font>
<font color="green">//           </font>
<font color="green">// DESCRIPTION:</font>
<font color="green">//      This function does sprintf/wsprintf style formatting on CStdStringA</font>
<font color="green">//      objects.  It looks a lot like MFC's CString::Format.  Some people might</font>
<font color="green">//      even call this identical.  Unfortunately, these people have met with</font>
<font color="green">//      untimely deaths (heh heh...)</font>
<font color="green">//</font>
<font color="green">// PARAMETERS: </font>
<font color="green">//      nId - ID of string resource holding the format string</font>
<font color="green">//      szFormat - a PCSTR holding the format specifiers</font>
<font color="green">//      argList - a va_list holding the arguments for the format specifiers.</font>
<font color="green">//</font>
<font color="green">// RETURN VALUE:  None.</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// formatting (using wsprintf style formatting)</font>
<font color="blue">#ifndef</font> SS_ANSI
<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Format<font color="black">(</font>UINT nId, ...<font color="black">)</font>
<font color="black">{</font>
    va_list argList;
    va_start<font color="black">(</font>argList, nId<font color="black">)</font>;
    va_start<font color="black">(</font>argList, nId<font color="black">)</font>;

    MYTYPE strFmt;
    <font color="blue">if</font> <font color="black">(</font> strFmt.Load<font color="black">(</font>nId<font color="black">)</font> <font color="black">)</font>
        FormatV<font color="black">(</font>strFmt, argList<font color="black">)</font>;

    va_end<font color="black">(</font>argList<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">#endif</font>
<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Format<font color="black">(</font><font color="blue">const</font> CT<font color="black">*</font> szFormat, ...<font color="black">)</font>
<font color="black">{</font>
    va_list argList;
    va_start<font color="black">(</font>argList, szFormat<font color="black">)</font>;
    FormatV<font color="black">(</font>szFormat, argList<font color="black">)</font>;
    va_end<font color="black">(</font>argList<font color="black">)</font>;
<font color="black">}</font>

<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// FUNCTION:  CStdStr&#60;CT&#62;::FormatV</font>
<font color="green">//      void FormatV(PCSTR szFormat, va_list, argList);</font>
<font color="green">//           </font>
<font color="green">// DESCRIPTION:</font>
<font color="green">//      This function formats the string with sprintf style format-specs.  It</font>
<font color="green">//      makes a general guess at required buffer size and then tries</font>
<font color="green">//      successively larger buffers until it finds one big enough or a threshold</font>
<font color="green">//      (MAX_FMT_TRIES) is exceeded.</font>
<font color="green">//</font>
<font color="green">// PARAMETERS: </font>
<font color="green">//      szFormat - a PCSTR holding the format of the output</font>
<font color="green">//      argList - a Microsoft specific va_list for variable argument lists</font>
<font color="green">//</font>
<font color="green">// RETURN VALUE: </font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="blue">#define</font> MAX_FMT_TRIES       <font color="maroon">5</font>    <font color="green">// #of times we try if stack buffers not enough</font>
<font color="blue">#define</font> FMT_BLOCK_SIZE      <font color="maroon">2048</font> <font color="green">// # of bytes above BUFSIZE_2ND_TRY each try</font>
<font color="blue">#define</font> BUFSIZE_1ST <font color="maroon">256</font>
<font color="blue">#define</font> BUFSIZE_2ND <font color="maroon">512</font>
<font color="blue">#define</font> STD_BUF_SIZE        <font color="maroon">1024</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>FormatV<font color="black">(</font><font color="blue">const</font> CT<font color="black">*</font> szFormat, va_list argList<font color="black">)</font>
<font color="black">{</font>
<font color="blue">#ifdef</font> SS_ANSI

    <font color="blue">int</font> nLen    <font color="black">=</font> sslen<font color="black">(</font>szFormat<font color="black">)</font> <font color="black">+</font> STD_BUF_SIZE;
    ssvsprintf<font color="black">(</font>GetBuffer<font color="black">(</font>nLen<font color="black">)</font>, nLen<font color="maroon">-1</font>, szFormat, argList<font color="black">)</font>;
    ReleaseBuffer<font color="black">(</font><font color="black">)</font>;

<font color="blue">#else</font>

    <font color="green">// We're going to use the  _vsntprintf function, assuming FMT_BLOCK_SIZE</font>
    <font color="green">// characters.</font>

    <font color="blue">int</font> nTriesLeft          <font color="black">=</font> MAX_FMT_TRIES<font color="maroon">-1</font>;
    <font color="blue">int</font> nUsed               <font color="black">=</font> <font color="maroon">-1</font>;
    CT szBuf1<font color="black">[</font>BUFSIZE_1ST<font color="black">]</font>;
    
    <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font>nUsed<font color="black">=</font>ssnprintf<font color="black">(</font>szBuf1, BUFSIZE_1ST<font color="maroon">-1</font>, szFormat, argList<font color="black">)</font><font color="black">)</font> <font color="black">&#62;</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
    <font color="black">{</font>
        szBuf1<font color="black">[</font>nUsed<font color="black">]</font>       <font color="black">=</font> <font color="maroon">'\0'</font>;
        <font color="black">*</font><font color="blue">this</font>               <font color="black">=</font> szBuf1;
    <font color="black">}</font>
    <font color="blue">else</font>
    <font color="black">{</font>
        CT szBuf2<font color="black">[</font>BUFSIZE_2ND<font color="black">]</font>;
        <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font>nUsed<font color="black">=</font>ssnprintf<font color="black">(</font>szBuf2, BUFSIZE_2ND<font color="maroon">-1</font>, szFormat, argList<font color="black">)</font><font color="black">)</font><font color="black">&#62;</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
        <font color="black">{</font>
            szBuf2<font color="black">[</font>nUsed<font color="black">]</font>   <font color="black">=</font> <font color="maroon">'\0'</font>;
            <font color="black">*</font><font color="blue">this</font>           <font color="black">=</font> szBuf2;
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            <font color="blue">int</font> nChars      <font color="black">=</font> BUFSIZE_2ND; 

            <font color="green">// Loop until we succeed or we have exhausted the number of tries</font>

            <font color="blue">do</font>  
            <font color="black">{</font>
                nChars      <font color="black">+</font><font color="black">=</font> FMT_BLOCK_SIZE;  <font color="green">// # of TCHARS in the string</font>

                <font color="green">// Now try the actual formatting. </font>

                nUsed       <font color="black">=</font> ssnprintf<font color="black">(</font>Buffer<font color="black">(</font>nChars<font color="black">+</font><font color="maroon">1</font><font color="black">)</font>,
                                        nChars,
                                        szFormat,
                                        argList<font color="black">)</font>;

                <font color="blue">if</font> <font color="black">(</font> nUsed <font color="black">&#62;</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
                    resize<font color="black">(</font>nUsed<font color="black">)</font>;

            <font color="black">}</font> <font color="blue">while</font> <font color="black">(</font> nUsed <font color="black">&#60;</font> <font color="maroon">0</font> <font color="black">&</font><font color="black">&</font> <font color="black">-</font><font color="black">-</font>nTriesLeft <font color="black">&#62;</font> <font color="maroon">0</font><font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>
<font color="blue">#endif</font>
<font color="black">}</font>


<font color="green">// CStdStr -- COM IStream helpers</font>


<font color="blue">#ifdef</font> SS_INC_COMDEF

    <font color="blue">#define</font> SSSO_UNICODE    <font color="maroon">0x01</font>    <font color="green">// the string is a wide string</font>
    <font color="blue">#define</font> SSSO_COMPRESS   <font color="maroon">0x02</font>    <font color="green">// the string is compressed</font>

    <font color="blue">typedef</font> <font color="blue">struct</font> SSSHDR
    <font color="black">{</font>
        BYTE    byCtrl;
        ULONG   nChars;
    <font color="black">}</font> SSSHDR;   <font color="green">// as in "Standard String Stream Header"</font>

    <font color="green">// -----------------------------------------------------------------------------</font>
    <font color="green">// FUNCTION: CStdStr&#60;CT&#62;::StreamSize</font>
    <font color="green">// REMARKS:</font>
    <font color="green">// PARAMETERS:</font>
    <font color="green">// RETURN VALUE:</font>
    <font color="green">// -----------------------------------------------------------------------------</font>
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    ULONG CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>StreamSize<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
    <font color="black">{</font>
        <font color="green">// Control header plus string</font>
        ASSERT<font color="black">(</font>size<font color="black">(</font><font color="black">)</font><font color="black">*</font><font color="blue">sizeof</font><font color="black">(</font>CT<font color="black">)</font> <font color="black">&#60;</font> 0xffffffffUL <font color="black">-</font><font color="blue">sizeof</font><font color="black">(</font>SSSHDR<font color="black">)</font><font color="black">)</font>;
        <font color="blue">return</font> <font color="black">(</font>size<font color="black">(</font><font color="black">)</font> <font color="black">*</font> <font color="blue">sizeof</font><font color="black">(</font>CT<font color="black">)</font><font color="black">)</font> <font color="black">+</font> <font color="blue">sizeof</font><font color="black">(</font>SSSHDR<font color="black">)</font>;
    <font color="black">}</font>

    <font color="green">// -----------------------------------------------------------------------------</font>
    <font color="green">// FUNCTION: CStdStr&#60;CT&#62;::StreamSave</font>
    <font color="green">// REMARKS:</font>
    <font color="green">// PARAMETERS:</font>
    <font color="green">// RETURN VALUE:</font>
    <font color="green">// -----------------------------------------------------------------------------</font>
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    HRESULT CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>StreamSave<font color="black">(</font>IStream<font color="black">*</font> pStream<font color="black">)</font> <font color="blue">const</font>
    <font color="black">{</font>
        ASSERT<font color="black">(</font>size<font color="black">(</font><font color="black">)</font><font color="black">*</font><font color="blue">sizeof</font><font color="black">(</font>CT<font color="black">)</font> <font color="black">&#60;</font> 0xffffffffUL <font color="black">-</font><font color="blue">sizeof</font><font color="black">(</font>SSSHDR<font color="black">)</font><font color="black">)</font>;
        HRESULT hr      <font color="black">=</font> E_FAIL;
        ASSERT<font color="black">(</font>pStream <font color="black">!</font><font color="black">=</font> NULL<font color="black">)</font>;
        SSSHDR hdr;
        hdr.byCtrl      <font color="black">=</font> <font color="blue">sizeof</font><font color="black">(</font>CT<font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">2</font> ? SSSO_UNICODE <font color="black">:</font> <font color="maroon">0</font>;
        hdr.nChars      <font color="black">=</font> size<font color="black">(</font><font color="black">)</font>;


        <font color="blue">if</font> <font color="black">(</font> FAILED<font color="black">(</font>hr<font color="black">=</font>pStream<font color="black">-</font><font color="black">&#62;</font>Write<font color="black">(</font><font color="black">&</font>hdr, <font color="blue">sizeof</font><font color="black">(</font>SSSHDR<font color="black">)</font>, NULL<font color="black">)</font><font color="black">)</font> <font color="black">)</font>
            TRACE<font color="black">(</font>_T<font color="black">(</font><font color="maroon">"StreamSave: Cannot write control header, ERR=0x%X\n"</font><font color="black">)</font>, hr<font color="black">)</font>;
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> empty<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
            ;       <font color="green">// nothing to write</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> FAILED<font color="black">(</font>hr<font color="black">=</font>pStream<font color="black">-</font><font color="black">&#62;</font>Write<font color="black">(</font>c_str<font color="black">(</font><font color="black">)</font>, size<font color="black">(</font><font color="black">)</font><font color="black">*</font><font color="blue">sizeof</font><font color="black">(</font>CT<font color="black">)</font>, NULL<font color="black">)</font><font color="black">)</font> <font color="black">)</font>
            TRACE<font color="black">(</font>_T<font color="black">(</font><font color="maroon">"StreamSave: Cannot write string to stream 0x%X\n"</font><font color="black">)</font>, hr<font color="black">)</font>;

        <font color="blue">return</font> hr;
    <font color="black">}</font>

    <font color="green">// -----------------------------------------------------------------------------</font>
    <font color="green">// FUNCTION: CStdStr&#60;CT&#62;::StreamLoad</font>
    <font color="green">// REMARKS:</font>
    <font color="green">//      This method loads the object from an IStream.</font>
    <font color="green">// PARAMETERS:</font>
    <font color="green">// RETURN VALUE:</font>
    <font color="green">// -----------------------------------------------------------------------------</font>
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    HRESULT CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>StreamLoad<font color="black">(</font>IStream<font color="black">*</font> pStream<font color="black">)</font>
    <font color="black">{</font>
        ASSERT<font color="black">(</font>pStream <font color="black">!</font><font color="black">=</font> NULL<font color="black">)</font>;
        SSSHDR hdr;
        HRESULT hr          <font color="black">=</font> E_FAIL;

        <font color="blue">if</font> <font color="black">(</font> FAILED<font color="black">(</font>hr<font color="black">=</font>pStream<font color="black">-</font><font color="black">&#62;</font>Read<font color="black">(</font><font color="black">&</font>hdr, <font color="blue">sizeof</font><font color="black">(</font>SSSHDR<font color="black">)</font>, NULL<font color="black">)</font><font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            TRACE<font color="black">(</font>_T<font color="black">(</font><font color="maroon">"StreamLoad: Unable to read control header, ERR=0x%X\n"</font><font color="black">)</font>, hr<font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> hdr.nChars <font color="black">&#62;</font> <font color="maroon">0</font> <font color="black">)</font>
        <font color="black">{</font>
            ULONG nRead     <font color="black">=</font> <font color="maroon">0</font>;
            PMYSTR pMyBuf   <font color="black">=</font> BufferSet<font color="black">(</font>hdr.nChars<font color="black">)</font>;

            <font color="green">// If our character size matches the character size of the string we're</font>
            <font color="green">// trying to read, then we can read it directly into our buffer.</font>
            <font color="green">// Otherwise, we have to read into an intermediate buffer and convert.</font>
            
            <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font>hdr.byCtrl <font color="black">&</font> SSSO_UNICODE<font color="black">)</font> <font color="black">!</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
            <font color="black">{</font>
                ULONG nBytes    <font color="black">=</font> hdr.nChars <font color="black">*</font> <font color="blue">sizeof</font><font color="black">(</font>wchar_t<font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font> <font color="blue">sizeof</font><font color="black">(</font>CT<font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="blue">sizeof</font><font color="black">(</font>wchar_t<font color="black">)</font> <font color="black">)</font>
                <font color="black">{</font>
                    <font color="blue">if</font> <font color="black">(</font> FAILED<font color="black">(</font>hr<font color="black">=</font>pStream<font color="black">-</font><font color="black">&#62;</font>Read<font color="black">(</font>pMyBuf, nBytes, <font color="black">&</font>nRead<font color="black">)</font><font color="black">)</font> <font color="black">)</font>
                        TRACE<font color="black">(</font>_T<font color="black">(</font><font color="maroon">"StreamLoad: Cannot read string: 0x%X\n"</font><font color="black">)</font>, hr<font color="black">)</font>;
                <font color="black">}</font>
                <font color="blue">else</font>
                <font color="black">{</font>   
                    PWSTR pBufW <font color="black">=</font> reinterpret_cast<font color="black">&#60;</font>PWSTR<font color="black">&#62;</font><font color="black">(</font>_alloca<font color="black">(</font><font color="black">(</font>nBytes<font color="black">)</font><font color="black">+</font><font color="maroon">1</font><font color="black">)</font><font color="black">)</font>;
                    <font color="blue">if</font> <font color="black">(</font> FAILED<font color="black">(</font>hr<font color="black">=</font>pStream<font color="black">-</font><font color="black">&#62;</font>Read<font color="black">(</font>pBufW, nBytes, <font color="black">&</font>nRead<font color="black">)</font><font color="black">)</font> <font color="black">)</font>
                        TRACE<font color="black">(</font>_T<font color="black">(</font><font color="maroon">"StreamLoad: Cannot read string: 0x%X\n"</font><font color="black">)</font>, hr<font color="black">)</font>;
                    <font color="blue">else</font>
                        sscpy<font color="black">(</font>pMyBuf, pBufW, hdr.nChars<font color="black">*</font><font color="blue">sizeof</font><font color="black">(</font>wchar_t<font color="black">)</font><font color="black">)</font>;
                <font color="black">}</font>
            <font color="black">}</font>
            <font color="blue">else</font>
            <font color="black">{</font>
                ULONG nBytes    <font color="black">=</font> hdr.nChars <font color="black">*</font> <font color="blue">sizeof</font><font color="black">(</font><font color="blue">char</font><font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font> <font color="blue">sizeof</font><font color="black">(</font>CT<font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="blue">sizeof</font><font color="black">(</font><font color="blue">char</font><font color="black">)</font> <font color="black">)</font>
                <font color="black">{</font>
                    <font color="blue">if</font> <font color="black">(</font> FAILED<font color="black">(</font>hr<font color="black">=</font>pStream<font color="black">-</font><font color="black">&#62;</font>Read<font color="black">(</font>pMyBuf, nBytes, <font color="black">&</font>nRead<font color="black">)</font><font color="black">)</font> <font color="black">)</font>
                        TRACE<font color="black">(</font>_T<font color="black">(</font><font color="maroon">"StreamLoad: Cannot read string: 0x%X\n"</font><font color="black">)</font>, hr<font color="black">)</font>;
                <font color="black">}</font>
                <font color="blue">else</font>
                <font color="black">{</font>
                    PSTR pBufA <font color="black">=</font> reinterpret_cast<font color="black">&#60;</font>PSTR<font color="black">&#62;</font><font color="black">(</font>_alloca<font color="black">(</font>nBytes<font color="black">)</font><font color="black">)</font>;
                    <font color="blue">if</font> <font color="black">(</font> FAILED<font color="black">(</font>hr<font color="black">=</font>pStream<font color="black">-</font><font color="black">&#62;</font>Read<font color="black">(</font>pBufA, hdr.nChars, <font color="black">&</font>nRead<font color="black">)</font><font color="black">)</font> <font color="black">)</font>
                        TRACE<font color="black">(</font>_T<font color="black">(</font><font color="maroon">"StreamLoad: Cannot read string: 0x%X\n"</font><font color="black">)</font>, hr<font color="black">)</font>;
                    <font color="blue">else</font>
                        sscpy<font color="black">(</font>pMyBuf, pBufA, hdr.nChars<font color="black">)</font>;
                <font color="black">}</font>
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            <font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>erase<font color="black">(</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">return</font> hr;
    <font color="black">}</font>
<font color="blue">#endif</font> <font color="green">// #ifdef SS_INC_COMDEF</font>


<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// CString Facade Functions:</font>
<font color="green">//</font>
<font color="green">// The following methods are intended to allow you to use this class as a</font>
<font color="green">// drop-in replacement for CString.</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="blue">#ifndef</font> SS_ANSI
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font>
    BSTR CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>AllocSysString<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
    <font color="black">{</font>
        ostring os;
        ssasn<font color="black">(</font>os, <font color="black">*</font><font color="blue">this</font><font color="black">)</font>;
        <font color="blue">return</font> <font color="black">:</font><font color="black">:</font>SysAllocString<font color="black">(</font>os.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#endif</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Collate<font color="black">(</font>PCMYSTR szThat<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> sscoll<font color="black">(</font>c_str<font color="black">(</font><font color="black">)</font>, length<font color="black">(</font><font color="black">)</font>, szThat, sslen<font color="black">(</font>szThat<font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>CollateNoCase<font color="black">(</font>PCMYSTR szThat<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> ssicoll<font color="black">(</font>c_str<font color="black">(</font><font color="black">)</font>, length<font color="black">(</font><font color="black">)</font>, szThat, sslen<font color="black">(</font>szThat<font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>CompareNoCase<font color="black">(</font>PCMYSTR szThat<font color="black">)</font>  <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> ssicmp<font color="black">(</font>c_str<font color="black">(</font><font color="black">)</font>, szThat<font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Delete<font color="black">(</font><font color="blue">int</font> nIdx, <font color="blue">int</font> nCount<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> nIdx <font color="black">&#60;</font> GetLength<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
        erase<font color="black">(</font>static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nIdx<font color="black">)</font>, static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nCount<font color="black">)</font><font color="black">)</font>;

    <font color="blue">return</font> GetLength<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Empty<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    erase<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Find<font color="black">(</font>CT ch<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    MYSIZE nIdx <font color="black">=</font> find_first_of<font color="black">(</font>ch<font color="black">)</font>;
    <font color="blue">return</font> static_cast<font color="black">&#60;</font><font color="blue">int</font><font color="black">&#62;</font><font color="black">(</font>nIdx <font color="black">=</font><font color="black">=</font> npos ? <font color="maroon">-1</font> <font color="black">:</font> nIdx<font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Find<font color="black">(</font>PCMYSTR szSub<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    MYSIZE nIdx <font color="black">=</font> find<font color="black">(</font>szSub<font color="black">)</font>;
    <font color="blue">return</font> static_cast<font color="black">&#60;</font><font color="blue">int</font><font color="black">&#62;</font><font color="black">(</font>nIdx <font color="black">=</font><font color="black">=</font> npos ? <font color="maroon">-1</font> <font color="black">:</font> nIdx<font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Find<font color="black">(</font>CT ch, <font color="blue">int</font> nStart<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="green">// must add 1 because Find excludes first character</font>

    MYSIZE nIdx <font color="black">=</font> find_first_of<font color="black">(</font>ch, static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nStart<font color="black">+</font><font color="maroon">1</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">return</font> static_cast<font color="black">&#60;</font><font color="blue">int</font><font color="black">&#62;</font><font color="black">(</font>nIdx <font color="black">=</font><font color="black">=</font> npos ? <font color="maroon">-1</font> <font color="black">:</font> nIdx<font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Find<font color="black">(</font>PCMYSTR szSub, <font color="blue">int</font> nStart<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="green">// must add 1 because Find excludes first character</font>

    MYSIZE nIdx <font color="black">=</font> find<font color="black">(</font>szSub, static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nStart<font color="black">+</font><font color="maroon">1</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">return</font> static_cast<font color="black">&#60;</font><font color="blue">int</font><font color="black">&#62;</font><font color="black">(</font>nIdx <font color="black">=</font><font color="black">=</font> npos ? <font color="maroon">-1</font> <font color="black">:</font> nIdx<font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>FindOneOf<font color="black">(</font>PCMYSTR szCharSet<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    MYSIZE nIdx <font color="black">=</font> find_first_of<font color="black">(</font>szCharSet<font color="black">)</font>;
    <font color="blue">return</font> static_cast<font color="black">&#60;</font><font color="blue">int</font><font color="black">&#62;</font><font color="black">(</font>nIdx <font color="black">=</font><font color="black">=</font> npos ? <font color="maroon">-1</font> <font color="black">:</font> nIdx<font color="black">)</font>;
<font color="black">}</font>

<font color="blue">#ifndef</font> SS_ANSI
<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>FormatMessage<font color="black">(</font>PCMYSTR szFormat, ...<font color="black">)</font> <font color="blue">throw</font><font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>exception<font color="black">)</font>
<font color="black">{</font>
    va_list argList;
    va_start<font color="black">(</font>argList, szFormat<font color="black">)</font>;
    PMYSTR szTemp;
    <font color="blue">if</font> <font color="black">(</font> ssfmtmsg<font color="black">(</font>FORMAT_MESSAGE_FROM_STRING<font color="black">|</font>FORMAT_MESSAGE_ALLOCATE_BUFFER,
                   szFormat, <font color="maroon">0</font>, <font color="maroon">0</font>,
                   reinterpret_cast<font color="black">&#60;</font>PMYSTR<font color="black">&#62;</font><font color="black">(</font><font color="black">&</font>szTemp<font color="black">)</font>, <font color="maroon">0</font>, <font color="black">&</font>argList<font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">|</font><font color="black">|</font>
         szTemp <font color="black">=</font><font color="black">=</font> NULL <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">throw</font> NSP<font color="black">:</font><font color="black">:</font>runtime_error<font color="black">(</font><font color="maroon">"out of memory"</font><font color="black">)</font>;
    <font color="black">}</font>
    <font color="black">*</font><font color="blue">this</font> <font color="black">=</font> szTemp;
    LocalFree<font color="black">(</font>szTemp<font color="black">)</font>;
    va_end<font color="black">(</font>argList<font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>FormatMessage<font color="black">(</font>UINT nFormatId, ...<font color="black">)</font> <font color="blue">throw</font><font color="black">(</font>NSP<font color="black">:</font><font color="black">:</font>exception<font color="black">)</font>
<font color="black">{</font>
    MYTYPE sFormat;
    VERIFY<font color="black">(</font>sFormat.LoadString<font color="black">(</font>nFormatId<font color="black">)</font> <font color="black">!</font><font color="black">=</font> <font color="maroon">0</font><font color="black">)</font>;
    va_list argList;
    va_start<font color="black">(</font>argList, nFormatId<font color="black">)</font>;
    PMYSTR szTemp;
    <font color="blue">if</font> <font color="black">(</font> ssfmtmsg<font color="black">(</font>FORMAT_MESSAGE_FROM_STRING<font color="black">|</font>FORMAT_MESSAGE_ALLOCATE_BUFFER,
                   sFormat, <font color="maroon">0</font>, <font color="maroon">0</font>,
                   reinterpret_cast<font color="black">&#60;</font>PMYSTR<font color="black">&#62;</font><font color="black">(</font><font color="black">&</font>szTemp<font color="black">)</font>, <font color="maroon">0</font>, <font color="black">&</font>argList<font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">|</font><font color="black">|</font>
        szTemp <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">throw</font> NSP<font color="black">:</font><font color="black">:</font>runtime_error<font color="black">(</font><font color="maroon">"out of memory"</font><font color="black">)</font>;
    <font color="black">}</font>
    <font color="black">*</font><font color="blue">this</font> <font color="black">=</font> szTemp;
    LocalFree<font color="black">(</font>szTemp<font color="black">)</font>;
    va_end<font color="black">(</font>argList<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">#endif</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CT CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>GetAt<font color="black">(</font><font color="blue">int</font> nIdx<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> at<font color="black">(</font>static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nIdx<font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CT<font color="black">*</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>GetBuffer<font color="black">(</font><font color="blue">int</font> nMinLen<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> Buffer<font color="black">(</font>nMinLen<font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CT<font color="black">*</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>GetBufferSetLength<font color="black">(</font><font color="blue">int</font> nLen<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> BufferSet<font color="black">(</font>nLen<font color="black">)</font>;
<font color="black">}</font>

<font color="green">// GetLength() -- MFC docs say this is the # of BYTES but</font>
<font color="green">// in truth it is the number of CHARACTERs (chars or wchar_ts)</font>
<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>GetLength<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> static_cast<font color="black">&#60;</font><font color="blue">int</font><font color="black">&#62;</font><font color="black">(</font>length<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Insert<font color="black">(</font><font color="blue">int</font> nIdx, CT ch<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nIdx<font color="black">)</font> <font color="black">&#62;</font> size<font color="black">(</font><font color="black">)</font> <font color="maroon">-1</font> <font color="black">)</font>
        append<font color="black">(</font><font color="maroon">1</font>, ch<font color="black">)</font>;
    <font color="blue">else</font>
        insert<font color="black">(</font>static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nIdx<font color="black">)</font>, <font color="maroon">1</font>, ch<font color="black">)</font>;

    <font color="blue">return</font> GetLength<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Insert<font color="black">(</font><font color="blue">int</font> nIdx, PCMYSTR sz<font color="black">)</font>
<font color="black">{</font>
    insert<font color="black">(</font>static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nIdx<font color="black">)</font>, sz<font color="black">)</font>;
    <font color="blue">return</font> GetLength<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font> 
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Left<font color="black">(</font><font color="blue">int</font> nCount<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> substr<font color="black">(</font><font color="maroon">0</font>, static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nCount<font color="black">)</font><font color="black">)</font>; 
<font color="black">}</font>

<font color="blue">#ifndef</font> SS_ANSI
<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">bool</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>LoadString<font color="black">(</font>UINT nId<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> <font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>Load<font color="black">(</font>nId<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">#endif</font>
<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>MakeLower<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    ToLower<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>MakeReverse<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    NSP<font color="black">:</font><font color="black">:</font>reverse<font color="black">(</font>begin<font color="black">(</font><font color="black">)</font>, end<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>MakeUpper<font color="black">(</font><font color="black">)</font>
<font color="black">{</font> 
    ToUpper<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Mid<font color="black">(</font><font color="blue">int</font> nFirst <font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> substr<font color="black">(</font>static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nFirst<font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Mid<font color="black">(</font><font color="blue">int</font> nFirst, <font color="blue">int</font> nCount<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> substr<font color="black">(</font>static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nFirst<font color="black">)</font>, static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nCount<font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>ReleaseBuffer<font color="black">(</font><font color="blue">int</font> nNewLen<font color="black">)</font>
<font color="black">{</font>
    BufferRel<font color="black">(</font>nNewLen<font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Remove<font color="black">(</font>CT ch<font color="black">)</font>
<font color="black">{</font>
    MYSIZE nIdx     <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">int</font> nRemoved    <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">while</font> <font color="black">(</font> <font color="black">(</font>nIdx<font color="black">=</font>find_first_of<font color="black">(</font>ch<font color="black">)</font><font color="black">)</font> <font color="black">!</font><font color="black">=</font> npos <font color="black">)</font>
    <font color="black">{</font>
        erase<font color="black">(</font>nIdx, <font color="maroon">1</font><font color="black">)</font>;
        nRemoved<font color="black">+</font><font color="black">+</font>;
    <font color="black">}</font>
    <font color="blue">return</font> nRemoved;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Replace<font color="black">(</font>TCHAR chOld, TCHAR chNew<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">int</font> nReplaced   <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">for</font> <font color="black">(</font> MYITER iter<font color="black">=</font>begin<font color="black">(</font><font color="black">)</font>; iter <font color="black">!</font><font color="black">=</font> end<font color="black">(</font><font color="black">)</font>; iter<font color="black">+</font><font color="black">+</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> <font color="black">*</font>iter <font color="black">=</font><font color="black">=</font> chOld <font color="black">)</font>
        <font color="black">{</font>
            <font color="black">*</font>iter <font color="black">=</font> chNew;
            nReplaced<font color="black">+</font><font color="black">+</font>;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">return</font> nReplaced;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Replace<font color="black">(</font>PCMYSTR szOld, PCMYSTR szNew<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">int</font> nReplaced       <font color="black">=</font> <font color="maroon">0</font>;
    MYSIZE nIdx         <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">static</font> <font color="blue">const</font> CT _C  <font color="black">=</font> CT<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>;
    MYSIZE nOldLen      <font color="black">=</font> sslen<font color="black">(</font>szOld<font color="black">)</font>;
    MYSIZE nNewLen      <font color="black">=</font> sslen<font color="black">(</font>szNew<font color="black">)</font>;
    PCMYSTR szRealNew   <font color="black">=</font> szNew <font color="black">=</font><font color="black">=</font> NULL ? <font color="black">&</font>_C <font color="black">:</font> szNew;
    PCMYSTR szRealOld   <font color="black">=</font> szOld <font color="black">=</font><font color="black">=</font> NULL ? <font color="black">&</font>_C <font color="black">:</font> szOld;
    <font color="blue">while</font> <font color="black">(</font> <font color="black">(</font>nIdx<font color="black">=</font>find<font color="black">(</font>szRealOld, nIdx<font color="black">)</font><font color="black">)</font> <font color="black">!</font><font color="black">=</font> npos <font color="black">)</font>
    <font color="black">{</font>
        replace<font color="black">(</font>begin<font color="black">(</font><font color="black">)</font><font color="black">+</font>nIdx, begin<font color="black">(</font><font color="black">)</font><font color="black">+</font>nIdx<font color="black">+</font>nOldLen, szRealNew<font color="black">)</font>;
        nReplaced<font color="black">+</font><font color="black">+</font>;
        nIdx <font color="black">+</font><font color="black">=</font> nNewLen;
    <font color="black">}</font>
    <font color="blue">return</font> nReplaced;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">int</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>ReverseFind<font color="black">(</font>CT ch<font color="black">)</font>
<font color="black">{</font>
    MYSIZE nIdx <font color="black">=</font> find_last_of<font color="black">(</font>ch<font color="black">)</font>;
    <font color="blue">return</font> static_cast<font color="black">&#60;</font><font color="blue">int</font><font color="black">&#62;</font><font color="black">(</font>nIdx <font color="black">=</font><font color="black">=</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>npos ? <font color="maroon">-1</font> <font color="black">:</font> nIdx<font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>Right<font color="black">(</font><font color="blue">int</font> nCount<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    nCount <font color="black">=</font> SSMIN<font color="black">(</font>nCount, static_cast<font color="black">&#60;</font><font color="blue">int</font><font color="black">&#62;</font><font color="black">(</font>size<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">return</font> substr<font color="black">(</font>size<font color="black">(</font><font color="black">)</font><font color="black">-</font>static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nCount<font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
<font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>SetAt<font color="black">(</font><font color="blue">int</font> nIndex, CT ch<font color="black">)</font>
<font color="black">{</font>
    ASSERT<font color="black">(</font>size<font color="black">(</font><font color="black">)</font> <font color="black">&#62;</font> static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nIndex<font color="black">)</font><font color="black">)</font>;
    at<font color="black">(</font>static_cast<font color="black">&#60;</font>MYSIZE<font color="black">&#62;</font><font color="black">(</font>nIndex<font color="black">)</font><font color="black">)</font>     <font color="black">=</font> ch;
<font color="black">}</font>

<font color="blue">#ifndef</font> SS_ANSI
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    BSTR CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>SetSysString<font color="black">(</font>BSTR<font color="black">*</font> pbstr<font color="black">)</font> <font color="blue">const</font>
    <font color="black">{</font>
        ostring os;
        ssasn<font color="black">(</font>os, <font color="black">*</font><font color="blue">this</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font><font color="black">:</font><font color="black">:</font>SysReAllocStringLen<font color="black">(</font>pbstr, os.c_str<font color="black">(</font><font color="black">)</font>, os.length<font color="black">(</font><font color="black">)</font><font color="black">)</font> <font color="black">)</font>
            <font color="blue">throw</font> NSP<font color="black">:</font><font color="black">:</font>runtime_error<font color="black">(</font><font color="maroon">"out of memory"</font><font color="black">)</font>;

        ASSERT<font color="black">(</font><font color="black">*</font>pbstr <font color="black">!</font><font color="black">=</font> NULL<font color="black">)</font>;
        <font color="blue">return</font> <font color="black">*</font>pbstr;
    <font color="black">}</font>
<font color="blue">#endif</font>
<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>SpanExcluding<font color="black">(</font>PCMYSTR szCharSet<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> Left<font color="black">(</font>find_first_of<font color="black">(</font>szCharSet<font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
<font color="blue">inline</font>
CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>SpanIncluding<font color="black">(</font>PCMYSTR szCharSet<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> Left<font color="black">(</font>find_first_not_of<font color="black">(</font>szCharSet<font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">#if</font> <font color="black">!</font>defined<font color="black">(</font>UNICODE<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font>defined<font color="black">(</font>SS_ANSI<font color="black">)</font>

    <font color="green">// CString's OemToAnsi and AnsiToOem functions are available only in Unicode</font>
    <font color="green">// builds.  However since we're a template we also need a runtime check of</font>
    <font color="green">// CT and a reinterpret_cast to account for the fact that CStdStringW gets</font>
    <font color="green">// instantiated even in non-Unicode builds.</font>


    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font>
    <font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>AnsiToOem<font color="black">(</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> <font color="blue">sizeof</font><font color="black">(</font>CT<font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="blue">sizeof</font><font color="black">(</font><font color="blue">char</font><font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font>empty<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            <font color="black">:</font><font color="black">:</font>CharToOem<font color="black">(</font>reinterpret_cast<font color="black">&#60;</font>PCSTR<font color="black">&#62;</font><font color="black">(</font>c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>,
                        reinterpret_cast<font color="black">&#60;</font>PSTR<font color="black">&#62;</font><font color="black">(</font>Buffer<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            ASSERT<font color="black">(</font><font color="blue">false</font><font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>

    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font>
    <font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>OemToAnsi<font color="black">(</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> <font color="blue">sizeof</font><font color="black">(</font>CT<font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="blue">sizeof</font><font color="black">(</font><font color="blue">char</font><font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font>empty<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            <font color="black">:</font><font color="black">:</font>OemToChar<font color="black">(</font>reinterpret_cast<font color="black">&#60;</font>PCSTR<font color="black">&#62;</font><font color="black">(</font>c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>,
                        reinterpret_cast<font color="black">&#60;</font>PSTR<font color="black">&#62;</font><font color="black">(</font>Buffer<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            ASSERT<font color="black">(</font><font color="blue">false</font><font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>

<font color="blue">#endif</font>

<font color="green">// =============================================================================</font>
<font color="green">//                      END OF CStdStr INLINE FUNCTION DEFINITIONS</font>
<font color="green">// =============================================================================</font>

<font color="green">//  Now typedef our class names based upon this humongous template</font>

<font color="blue">typedef</font> CStdStr<font color="black">&#60;</font><font color="blue">char</font><font color="black">&#62;</font>       CStdStringA;    <font color="green">// a better NSP::string</font>
<font color="blue">typedef</font> CStdStr<font color="black">&#60;</font>wchar_t<font color="black">&#62;</font>    CStdStringW;    <font color="green">// a better NSP::wstring</font>
<font color="blue">typedef</font> CStdStr<font color="black">&#60;</font>OLECHAR<font color="black">&#62;</font>    CStdStringO;    <font color="green">// almost always CStdStringW</font>

<font color="green">// our MFC-like resource handle</font>

<font color="blue">inline</font> HMODULE<font color="black">&</font> SSResourceHandle<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">static</font> HMODULE hModuleSS    <font color="black">=</font> GetModuleHandle<font color="black">(</font>NULL<font color="black">)</font>;
    <font color="blue">return</font> hModuleSS;
<font color="black">}</font>



<font color="green">// In MFC builds, define some global serialization operators</font>
<font color="green">// Special operators that allow us to serialize CStdStrings to CArchives.</font>
<font color="green">// Note that we use an intermediate CString object in order to ensure that</font>
<font color="green">// we use the exact same format.</font>

<font color="blue">#ifdef</font> _MFC_VER
    <font color="blue">inline</font> CArchive<font color="black">&</font> AFXAPI <font color="blue">operator</font><font color="black">&#60;</font><font color="black">&#60;</font><font color="black">(</font>CArchive<font color="black">&</font> ar, <font color="blue">const</font> CStdStringA<font color="black">&</font> strA<font color="black">)</font>
    <font color="black">{</font>
        CString strTemp <font color="black">=</font> strA;
        <font color="blue">return</font> ar <font color="black">&#60;</font><font color="black">&#60;</font> strTemp;
    <font color="black">}</font>
    <font color="blue">inline</font> CArchive<font color="black">&</font> AFXAPI <font color="blue">operator</font><font color="black">&#60;</font><font color="black">&#60;</font><font color="black">(</font>CArchive<font color="black">&</font> ar, <font color="blue">const</font> CStdStringW<font color="black">&</font> strW<font color="black">)</font>
    <font color="black">{</font>
        CString strTemp <font color="black">=</font> strW;
        <font color="blue">return</font> ar <font color="black">&#60;</font><font color="black">&#60;</font> strTemp;
    <font color="black">}</font>

    <font color="blue">inline</font> CArchive<font color="black">&</font> AFXAPI <font color="blue">operator</font><font color="black">&#62;</font><font color="black">&#62;</font><font color="black">(</font>CArchive<font color="black">&</font> ar, CStdStringA<font color="black">&</font> strA<font color="black">)</font>
    <font color="black">{</font>
        CString strTemp;
        ar <font color="black">&#62;</font><font color="black">&#62;</font> strTemp;
        strA <font color="black">=</font> strTemp;
        <font color="blue">return</font> ar;
    <font color="black">}</font>
    <font color="blue">inline</font> CArchive<font color="black">&</font> AFXAPI <font color="blue">operator</font><font color="black">&#62;</font><font color="black">&#62;</font><font color="black">(</font>CArchive<font color="black">&</font> ar, CStdStringW<font color="black">&</font> strW<font color="black">)</font>
    <font color="black">{</font>
        CString strTemp;
        ar <font color="black">&#62;</font><font color="black">&#62;</font> strTemp;
        strW <font color="black">=</font> strTemp;
        <font color="blue">return</font> ar;
    <font color="black">}</font>

    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font> <font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>SetResourceHandle<font color="black">(</font>HMODULE hNew<font color="black">)</font>
    <font color="black">{</font>
        AfxSetResourceHandle<font color="black">(</font>hNew<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font> <font color="blue">inline</font> HMODULE CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>GetResourceHandle<font color="black">(</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> AfxGetResourceHandle<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#else</font>
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font> <font color="blue">void</font> CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>SetResourceHandle<font color="black">(</font>HMODULE hNew<font color="black">)</font>
    <font color="black">{</font>
        SSResourceHandle<font color="black">(</font><font color="black">)</font> <font color="black">=</font> hNew;
    <font color="black">}</font>
    <font color="blue">template</font><font color="black">&#60;</font>typename CT<font color="black">&#62;</font>
    <font color="blue">inline</font> HMODULE CStdStr<font color="black">&#60;</font>CT<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>GetResourceHandle<font color="black">(</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">return</font> SSResourceHandle<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#endif</font>

<font color="green">// WUSysMessage -- return the system string corresponding to a system error or</font>
<font color="green">// HRESULT value.</font>
<font color="blue">#define</font> SS_DEFLANGID MAKELANGID<font color="black">(</font>LANG_NEUTRAL,SUBLANG_DEFAULT<font color="black">)</font>

<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// GLOBAL FUNCTION:  WUFormat</font>
<font color="green">//      CStdStringA WUFormat(UINT nId, ...);</font>
<font color="green">//      CStdStringA WUFormat(PCSTR szFormat, ...);</font>
<font color="green">//</font>
<font color="green">// REMARKS:</font>
<font color="green">//      This function allows the caller for format and return a CStdStringA</font>
<font color="green">//      object with a single line of code.</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="blue">#ifdef</font> SS_ANSI
<font color="blue">#else</font>
    <font color="blue">inline</font> CStdStringA WUFormatA<font color="black">(</font>UINT nId, ...<font color="black">)</font>
    <font color="black">{</font>
        va_list argList;
        va_start<font color="black">(</font>argList, nId<font color="black">)</font>;

        CStdStringA strFmt;
        CStdStringA strOut;
        <font color="blue">if</font> <font color="black">(</font> strFmt.Load<font color="black">(</font>nId<font color="black">)</font> <font color="black">)</font>
            strOut.FormatV<font color="black">(</font>strFmt, argList<font color="black">)</font>;

        va_end<font color="black">(</font>argList<font color="black">)</font>;
        <font color="blue">return</font> strOut;
    <font color="black">}</font>
    <font color="blue">inline</font> CStdStringA WUFormatA<font color="black">(</font>PCSTR szFormat, ...<font color="black">)</font>
    <font color="black">{</font>
        va_list argList;
        va_start<font color="black">(</font>argList, szFormat<font color="black">)</font>;
        CStdStringA strOut;
        strOut.FormatV<font color="black">(</font>szFormat, argList<font color="black">)</font>;
        va_end<font color="black">(</font>argList<font color="black">)</font>;
        <font color="blue">return</font> strOut;
    <font color="black">}</font>

    <font color="blue">inline</font> CStdStringW WUFormatW<font color="black">(</font>UINT nId, ...<font color="black">)</font>
    <font color="black">{</font>
        va_list argList;
        va_start<font color="black">(</font>argList, nId<font color="black">)</font>;

        CStdStringW strFmt;
        CStdStringW strOut;
        <font color="blue">if</font> <font color="black">(</font> strFmt.Load<font color="black">(</font>nId<font color="black">)</font> <font color="black">)</font>
            strOut.FormatV<font color="black">(</font>strFmt, argList<font color="black">)</font>;

        va_end<font color="black">(</font>argList<font color="black">)</font>;
        <font color="blue">return</font> strOut;
    <font color="black">}</font>
    <font color="blue">inline</font> CStdStringW WUFormatW<font color="black">(</font>PCWSTR szwFormat, ...<font color="black">)</font>
    <font color="black">{</font>
        va_list argList;
        va_start<font color="black">(</font>argList, szwFormat<font color="black">)</font>;
        CStdStringW strOut;
        strOut.FormatV<font color="black">(</font>szwFormat, argList<font color="black">)</font>;
        va_end<font color="black">(</font>argList<font color="black">)</font>;
        <font color="blue">return</font> strOut;
    <font color="black">}</font>
<font color="blue">#endif</font> <font color="green">// #ifdef SS_ANSI</font>

<font color="blue">#ifdef</font> SS_ANSI
<font color="blue">#else</font>
    <font color="green">// -------------------------------------------------------------------------</font>
    <font color="green">// FUNCTION: WUSysMessage</font>
    <font color="green">//   CStdStringA WUSysMessageA(DWORD dwError, DWORD dwLangId=SS_DEFLANGID);</font>
    <font color="green">//   CStdStringW WUSysMessageW(DWORD dwError, DWORD dwLangId=SS_DEFLANGID);</font>
    <font color="green">//           </font>
    <font color="green">// DESCRIPTION:</font>
    <font color="green">//   This function simplifies the process of obtaining a string equivalent</font>
    <font color="green">//   of a system error code returned from GetLastError().  You simply</font>
    <font color="green">//   supply the value returned by GetLastError() to this function and the</font>
    <font color="green">//   corresponding system string is returned in the form of a CStdStringA.</font>
    <font color="green">//</font>
    <font color="green">// PARAMETERS: </font>
    <font color="green">//   dwError - a DWORD value representing the error code to be translated</font>
    <font color="green">//   dwLangId - the language id to use.  defaults to english.</font>
    <font color="green">//</font>
    <font color="green">// RETURN VALUE: </font>
    <font color="green">//   a CStdStringA equivalent of the error code.  Currently, this function</font>
    <font color="green">//   only returns either English of the system default language strings.  </font>
    <font color="green">// -------------------------------------------------------------------------</font>
    <font color="blue">#define</font> SS_DEFLANGID MAKELANGID<font color="black">(</font>LANG_NEUTRAL,SUBLANG_DEFAULT<font color="black">)</font>
    <font color="blue">inline</font> CStdStringA WUSysMessageA<font color="black">(</font>DWORD dwError, DWORD dwLangId<font color="black">=</font>SS_DEFLANGID<font color="black">)</font>
    <font color="black">{</font>
        CHAR szBuf<font color="black">[</font><font color="maroon">512</font><font color="black">]</font>;

        <font color="blue">if</font> <font color="black">(</font> <font color="maroon">0</font> <font color="black">!</font><font color="black">=</font> <font color="black">:</font><font color="black">:</font>FormatMessageA<font color="black">(</font>FORMAT_MESSAGE_FROM_SYSTEM, NULL, dwError,
                                   dwLangId, szBuf, <font color="maroon">511</font>, NULL<font color="black">)</font> <font color="black">)</font>
            <font color="blue">return</font> WUFormatA<font color="black">(</font><font color="maroon">"%s (0x%X)"</font>, szBuf, dwError<font color="black">)</font>;
        <font color="blue">else</font>
            <font color="blue">return</font> WUFormatA<font color="black">(</font><font color="maroon">"Unknown error (0x%X)"</font>, dwError<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">inline</font> CStdStringW WUSysMessageW<font color="black">(</font>DWORD dwError, DWORD dwLangId<font color="black">=</font>SS_DEFLANGID<font color="black">)</font>
    <font color="black">{</font>
        WCHAR szBuf<font color="black">[</font><font color="maroon">512</font><font color="black">]</font>;

        <font color="blue">if</font> <font color="black">(</font> <font color="maroon">0</font> <font color="black">!</font><font color="black">=</font> <font color="black">:</font><font color="black">:</font>FormatMessageW<font color="black">(</font>FORMAT_MESSAGE_FROM_SYSTEM, NULL, dwError,
                                   dwLangId, szBuf, <font color="maroon">511</font>, NULL<font color="black">)</font> <font color="black">)</font>
            <font color="blue">return</font> WUFormatW<font color="black">(</font>L<font color="maroon">"%s (0x%X)"</font>, szBuf, dwError<font color="black">)</font>;
        <font color="blue">else</font>
            <font color="blue">return</font> WUFormatW<font color="black">(</font>L<font color="maroon">"Unknown error (0x%X)"</font>, dwError<font color="black">)</font>;
    <font color="black">}</font>
<font color="blue">#endif</font>

<font color="green">// Define TCHAR based friendly names for some of these functions</font>

<font color="blue">#ifdef</font> UNICODE
    <font color="blue">#define</font> CStdString              CStdStringW
    <font color="blue">#define</font> WUSysMessage            WUSysMessageW
    <font color="blue">#define</font> WUFormat                WUFormatW
<font color="blue">#else</font>
    <font color="blue">#define</font> CStdString              CStdStringA
    <font color="blue">#define</font> WUSysMessage            WUSysMessageA
    <font color="blue">#define</font> WUFormat                WUFormatA
<font color="blue">#endif</font>


<font color="blue">#define</font> WUSysMsg                    WUSysMessage
<font color="blue">#define</font> WUFmtA                      WUFormatA
<font color="blue">#define</font> WUFmtW                      WUFormatW
<font color="blue">#define</font> WUFmt                       WUFormat
<font color="blue">#define</font> WULastErrMsg<font color="black">(</font><font color="black">)</font>              WUSysMessage<font color="black">(</font><font color="black">:</font><font color="black">:</font>GetLastError<font color="black">(</font><font color="black">)</font><font color="black">)</font>


<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// FUNCTIONAL COMPARATORS:</font>
<font color="green">// REMARKS:</font>
<font color="green">//      These structs are derived from the NSP::binary_function template.  They</font>
<font color="green">//      give us functional classes (which may be used in Standard C++ Library</font>
<font color="green">//      collections and algorithms) that perform case-insensitive comparisons of</font>
<font color="green">//      CStdString objects.  This is useful for maps in which the key may be the</font>
<font color="green">//       proper string but in the wrong case.</font>
<font color="green">// -----------------------------------------------------------------------------</font>

<font color="blue">#define</font> StdStringLessNoCaseW        SSLNCW      <font color="green">// avoid compiler warning 4786</font>
<font color="blue">#define</font> StdStringEqualsNoCaseW      SSENCW      
<font color="blue">#define</font> StdStringLessNoCaseA        SSLNCA      
<font color="blue">#define</font> StdStringEqualsNoCaseA      SSENCA      

<font color="blue">#ifdef</font> UNICODE
    <font color="blue">#define</font> StdStringLessNoCase     SSLNCW      
    <font color="blue">#define</font> StdStringEqualsNoCase   SSENCW      
<font color="blue">#else</font>
    <font color="blue">#define</font> StdStringLessNoCase     SSLNCA      
    <font color="blue">#define</font> StdStringEqualsNoCase   SSENCA      
<font color="blue">#endif</font>

<font color="green">// -----------------------------------------------------------------------------</font>
<font color="green">// FUNCTION: </font>
<font color="green">// REMARKS:</font>
<font color="green">// PARAMETERS:</font>
<font color="green">// RETURN VALUE:</font>
<font color="green">// -----------------------------------------------------------------------------</font>
<font color="blue">struct</font> StdStringLessNoCaseW
    <font color="black">:</font> NSP<font color="black">:</font><font color="black">:</font>binary_function<font color="black">&#60;</font>CStdStringW, CStdStringW, <font color="blue">bool</font><font color="black">&#62;</font>
<font color="black">{</font>
    <font color="blue">inline</font>
    <font color="blue">bool</font> <font color="blue">operator</font><font color="black">(</font><font color="black">)</font><font color="black">(</font><font color="blue">const</font> CStdStringW<font color="black">&</font> sLeft, <font color="blue">const</font> CStdStringW<font color="black">&</font> sRight<font color="black">)</font> <font color="blue">const</font>
    <font color="black">{</font> <font color="blue">return</font> ssicmp<font color="black">(</font>sLeft.c_str<font color="black">(</font><font color="black">)</font>, sRight.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font> <font color="black">&#60;</font> <font color="maroon">0</font>; <font color="black">}</font>
<font color="black">}</font>;
<font color="blue">struct</font> StdStringEqualsNoCaseW
    <font color="black">:</font> NSP<font color="black">:</font><font color="black">:</font>binary_function<font color="black">&#60;</font>CStdStringW, CStdStringW, <font color="blue">bool</font><font color="black">&#62;</font>
<font color="black">{</font>
    <font color="blue">inline</font>
    <font color="blue">bool</font> <font color="blue">operator</font><font color="black">(</font><font color="black">)</font><font color="black">(</font><font color="blue">const</font> CStdStringW<font color="black">&</font> sLeft, <font color="blue">const</font> CStdStringW<font color="black">&</font> sRight<font color="black">)</font> <font color="blue">const</font>
    <font color="black">{</font> <font color="blue">return</font> ssicmp<font color="black">(</font>sLeft.c_str<font color="black">(</font><font color="black">)</font>, sRight.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font>; <font color="black">}</font>
<font color="black">}</font>;
<font color="blue">struct</font> StdStringLessNoCaseA
    <font color="black">:</font> NSP<font color="black">:</font><font color="black">:</font>binary_function<font color="black">&#60;</font>CStdStringA, CStdStringA, <font color="blue">bool</font><font color="black">&#62;</font>
<font color="black">{</font>
    <font color="blue">inline</font>
    <font color="blue">bool</font> <font color="blue">operator</font><font color="black">(</font><font color="black">)</font><font color="black">(</font><font color="blue">const</font> CStdStringA<font color="black">&</font> sLeft, <font color="blue">const</font> CStdStringA<font color="black">&</font> sRight<font color="black">)</font> <font color="blue">const</font>
    <font color="black">{</font> <font color="blue">return</font> ssicmp<font color="black">(</font>sLeft.c_str<font color="black">(</font><font color="black">)</font>, sRight.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font> <font color="black">&#60;</font> <font color="maroon">0</font>; <font color="black">}</font>
<font color="black">}</font>;
<font color="blue">struct</font> StdStringEqualsNoCaseA
    <font color="black">:</font> NSP<font color="black">:</font><font color="black">:</font>binary_function<font color="black">&#60;</font>CStdStringA, CStdStringA, <font color="blue">bool</font><font color="black">&#62;</font>
<font color="black">{</font>
    <font color="blue">inline</font>
    <font color="blue">bool</font> <font color="blue">operator</font><font color="black">(</font><font color="black">)</font><font color="black">(</font><font color="blue">const</font> CStdStringA<font color="black">&</font> sLeft, <font color="blue">const</font> CStdStringA<font color="black">&</font> sRight<font color="black">)</font> <font color="blue">const</font>
    <font color="black">{</font> <font color="blue">return</font> ssicmp<font color="black">(</font>sLeft.c_str<font color="black">(</font><font color="black">)</font>, sRight.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font>; <font color="black">}</font>
<font color="black">}</font>;

<font color="green">// If we had to define our own version of TRACE above, get rid of it now</font>

<font color="blue">#ifdef</font> TRACE_DEFINED_HERE
    <font color="blue">#undef</font> TRACE
    <font color="blue">#undef</font> TRACE_DEFINED_HERE
<font color="blue">#endif</font>





<font color="blue">#endif</font>  <font color="green">// #ifndef _STDSTRING_H_</font>

</PRE>
</BODY>
</HTML>
